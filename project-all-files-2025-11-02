# PROJECT FILES
# Total Files: 13
# Generated: 2025-11-02T21:55:11.195Z
# ======================================================================


================================================================================
FOLDER: .github/codeql
================================================================================

--------------------------------------------------------------------------------
FILE: .github/codeql/codeql-config.yml
STATUS: New
SIZE: 75 Bytes | LINES: 6
--------------------------------------------------------------------------------
name: python-codeql
paths:
  - main.py
  - scraper
  - selectolax
  - tests


================================================================================
FOLDER: .github/workflows
================================================================================

--------------------------------------------------------------------------------
FILE: .github/workflows/codeql.yml
STATUS: New
SIZE: 27.58 KB | LINES: 485
--------------------------------------------------------------------------------
name: CodeQL

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: '0 0 * * 0'

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Python sources
        id: detect_python
        run: |
          files="$(git ls-files '*.py')"
          if [ -n "$files" ]; then
            echo "has_python=true" >> "$GITHUB_OUTPUT"
          else
            echo "No Python sources detected; skipping CodeQL." >> "$GITHUB_STEP_SUMMARY"
            echo "has_python=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Initialize CodeQL
        if: steps.detect_python.outputs.has_python == 'true'
        uses: github/codeql-action/init@v3
        with:
          languages: python
          config-file: ./.github/codeql/codeql-config.yml

      - name: Autobuild
        if: steps.detect_python.outputs.has_python == 'true'
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        if: steps.detect_python.outputs.has_python == 'true'
        uses: github/codeql-action/analyze@v3
README.md
+430
-1

# SELENIUM-AUTOMATION-FOR-OWNER-NAME
# Montréal Role d'évaluation Scraper

This project automates the Montréal Rôle d’évaluation foncière workflow for CSV or Google Sheets inputs. It enriches rows with owner and assessment data while respecting ToS-friendly scraping practices (rate limiting, retries, and stealth browser behaviors).

## Features

- Playwright (Chromium) automation with basic stealth evasion.
- Supports CSV and Google Sheets sources via a unified CLI.
- Retries with exponential backoff and jittered delays between requests.
- SQLite cache prevents duplicate work on re-runs.
- Deterministic output schema appended to each data source.
- Atomic CSV overwrites, timestamped backups, and snapshot exports.
- Google Sheets batching with rollback-aware retry handling.
- Structured logging to console and `logs/run.log`.

## Requirements

- Python 3.11
- Playwright dependencies (Chromium browser binaries)

Install Python dependencies:

```bash
pip install -r requirements.txt
playwright install
```

## Environment Variables

Copy `.env.example` to `.env` and fill in the values:

| Variable | Description |
| --- | --- |
| `MONTREAL_EMAIL` | Optional: account email used when `--login` is supplied. |
| `MONTREAL_PASSWORD` | Optional: password for the Montréal account. |
| `GOOGLE_SERVICE_ACCOUNT_JSON` | Path to a Google service account JSON file or the JSON string itself. Required for Sheets mode. |
| `SHEET_NAME` / `SHEET_TAB` | Defaults for CLI flags. |
| `DELAY_MIN` / `DELAY_MAX` | Default jitter window (seconds). |
| `CACHE_PATH` | Path to the SQLite cache file. |
| `LOG_LEVEL` | Logging verbosity (e.g., `INFO`). |

## Google Sheets Setup

1. Create a Google Cloud project and enable the Sheets API.
2. Generate a service account with the "Editor" role.
3. Download the service account JSON and share your spreadsheet with the service account email.
4. Provide the JSON file path (or inline JSON string) via `GOOGLE_SERVICE_ACCOUNT_JSON`.

## CLI Usage

```bash
python main.py --csv ./input/mtl_targets.csv --max 250 --delay-min 1.5 --delay-max 3.0
python main.py --sheet "MTL Plex Leads" --tab "20-40" --from-row 2
python main.py --csv ./input/mtl_targets.csv --headful
python main.py --sheet "MTL Plex Leads" --tab "20-40" --login
```

## Configuring Git remotes for PR automation

This repository does not ship with a Git remote preconfigured. Tools that
attempt to open pull requests (including the provided `make_pr` helper)
require an upstream remote/branch to compare against. If you see errors such
as “no remote configured” or `fatal: No such remote: 'origin'`, add the
appropriate remote before re-running the tool:

```bash
git remote add origin https://github.com/MugiZer/SELENIUM-AUTOMATION-FOR-OWNER-NAME.git
git push -u origin work   # replace `work` with your current branch name
```

If you already have a different remote configured, you can update it instead:

```bash
git remote set-url origin https://github.com/MugiZer/SELENIUM-AUTOMATION-FOR-OWNER-NAME.git
```

After the first push, subsequent PR attempts will succeed because Git knows
which remote branch should receive updates.

### Manual pull request checklist

If you prefer creating the pull request through the GitHub UI (or need to
recover from a failed attempt), run the following commands locally. Replace
`<branch>` with the branch that contains your changes — you can always check it
with `git branch --show-current`.

```bash
# make sure all work is committed before switching
git status

# create or switch to the feature branch if necessary
git checkout -b <branch>        # or: git checkout <branch> if it already exists

# verify which branch you are on
git branch --show-current

# ensure the remote points to the public repository
git remote -v
git remote add origin https://github.com/MugiZer/SELENIUM-AUTOMATION-FOR-OWNER-NAME.git  # only if 'origin' is missing
git remote set-url origin https://github.com/MugiZer/SELENIUM-AUTOMATION-FOR-OWNER-NAME.git  # only if it points elsewhere

# publish the branch and establish the upstream tracking reference
git push -u origin <branch>
```

After the push completes, open the repository page in your browser and click
**Compare & pull request**. GitHub will pre-fill the base branch (`main`) and the
compare branch (`<branch>`). Review the diff, add a title/description, and submit
the PR. Future pushes to the same branch require only `git push` because the
upstream tracking relationship is already in place.

### Borough reference

The dataset must include a column containing the authoritative borough name for each address. The column name is `NO_ARROND_ILE_CUM` and each cell must match one of the following values exactly:

- Arrondissement de Villeray - Saint-Michel - Parc-Extension (Montréal)
- (Westmount)
- Arrondissement du Plateau-Mont-Royal (Montréal)
- Arrondissement du Sud-Ouest (Montréal)
- Arrondissement de Ville-Marie (Montréal)
- Arrondissement de Côte-des-Neiges - Notre-Dame-de-Grâce (Montréal)
- Saint Leonard
- Arrondissement de Lachine (Montréal)
- Arrondissement de Verdun (Montréal)
- Arrondissement de Rosemont - La Petite-Patrie
- Arrondissement de Pierrefonds - Roxboro (Montréal)
- Arrondissement d'Outremont (Montréal)
- Arrondissement de Saint-Laurent (Montréal)
- Arrondissement d'Ahuntsic-Cartierville
- Arrondissement de Mercier - Hochelaga-Maisonneuve (Montréal)

During scraping the list view may contain duplicate street names. The scraper uses the normalised value from `NO_ARROND_ILE_CUM` to pick the matching borough entry; when the column is missing or blank the workflow gracefully falls back to address-only matching and logs the loss of precision so operators can correct the dataset.

### Output Columns

Each processed row gains the following columns:

- `owner_names`
- `owner_type`
- `matricule`
- `tax_account_number`
- `municipality`
- `fiscal_years`
- `nb_logements`
- `assessed_terrain_current`
- `assessed_batiment_current`
- `assessed_total_current`
- `assessed_total_previous`
- `tax_distribution_json`
- `last_fetched_at`
- `source_url`
- `status`

## Logging

Logs are written to stdout and `logs/run.log` via a rotating handler. Adjust verbosity with the `LOG_LEVEL` environment variable.

## Testing

Unit tests cover the HTML parser logic:

```bash
pytest
```

## Troubleshooting

- **Playwright missing browsers**: run `playwright install`.
- **Authentication failures**: ensure `MONTREAL_EMAIL` and `MONTREAL_PASSWORD` are set and valid.
- **Sheets authentication**: confirm the spreadsheet is shared with the service account email and the JSON credentials are correct.
- **429 or 5xx responses**: the scraper retries automatically with exponential backoff while keeping rate limits.
- **Borough mismatches**: verify `NO_ARROND_ILE_CUM` values match the canonical list exactly; typos force the scraper to fall back to
  address-only matching and return a `multiple_matches` or `not_found` status.

## Appendix: DevTools Data (verbatim)

The following section is reproduced verbatim from the project brief to ensure selector fidelity.

✳️ DEVTOOLS DATA (append EXACTLY, do not modify)

https://montreal.ca/role-evaluation-fonciere/adresse

API NETWORK :

1)When we fill numéro d immeuble :

Request URL
https://www.google-analytics.com/g/collect?v=2&tid=G-X85NG0G8NT&gtm=45je5a11v9134341101z89134342162za200zb9134342162zd9134342162&_p=1759709177686&gcd=13l3l3l3l1l1&npa=0&dma=0&cid=1605043035.1759704688&ul=en-us&sr=1280x720&uaa=x86&uab=64&uafvl=Chromium%3B140.0.7339.185%7CNot%253DA%253FBrand%3B24.0.0.0%7CGoogle%2520Chrome%3B140.0.7339.185&uamb=0&uam=&uap=Windows&uapv=19.0.0&uaw=0&are=1&frm=0&pscdl=&_eu=AAAAAAQ&_s=1&tag_exp=101509157~103116026~103200004~103233427~104527907~104528500~104573694~104684208~104684211~104948813~115480710~115834636~115834638&sid=1759709127&sct=2&seg=1&dl=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse&dt=R%C3%B4le%20d%E2%80%99%C3%A9valuation%20fonci%C3%A8re&en=page_view&tfd=5478

Request Method
POST
Status Code
204 No Content
Remote Address
142.250.69.46:443
Referrer Policy
strict-origin-when-cross-origin
Request URL
https://www.google-analytics.com/g/collect?v=2&tid=G-X85NG0G8NT&gtm=45je5a11v9134341101za200zb9134342162zd9134342162&_p=1759709177686&gcd=13l3l3l3l1l1&npa=0&dma=0&cid=1605043035.1759704688&ul=en-us&sr=1280x720&uaa=x86&uab=64&uafvl=Chromium%3B140.0.7339.185%7CNot%253DA%253FBrand%3B24.0.0.0%7CGoogle%2520Chrome%3B140.0.7339.185&uamb=0&uam=&uap=Windows&uapv=19.0.0&uaw=0&are=1&frm=0&pscdl=&_eu=AEEAAAQ&_s=2&tag_exp=101509157~103116026~103200004~103233427~104527907~104528500~104573694~104684208~104684211~104948813~115480710~115834636~115834638&sid=1759709127&sct=2&seg=1&dl=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse&dt=R%C3%B4le%20d%E2%80%99%C3%A9valuation%20fonci%C3%A8re&en=form_start&ep.form_id=%C2%ABR6%C2%BB&ep.form_name=&ep.form_destination=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse%2Fliste&epn.form_length=13&ep.first_field_id=radix-%C2%ABr9%C2%BB&ep.first_field_name=civicNumber&ep.first_field_type=&epn.first_field_position=1&_et=4612&tfd=10492

2)when we fill Nom de la rue :
Request URL
https://montreal.ca/_next/data/info-recherche-2-3-13/fr-CA/role-evaluation-fonciere.json

Request Method
GET
Status Code
200 OK
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin
Request URL
https://montreal.ca/info-recherche/_next/static/css/406ef883613c4fbc.css

Request Method
GET
Status Code
200 OK (from disk cache)
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin
equest URL
https://montreal.ca/info-recherche/api/evaluation-fonciere/gem/streets?q=Bishop&page=1&size=10

Request Method
GET
Status Code
304 Not Modified
Remote Address
104.18.6.89:443
Referrer Policy
strict-origin-when-cross-origin
Request URL
https://www.google-analytics.com/g/collect?v=2&tid=G-X85NG0G8NT&gtm=45je5a11v9134341101z89134342162za200zb9134342162zd9134342162&_p=1759706936984&gcd=13l3l3l3l1l1&npa=0&dma=0&cid=1605043035.1759704688&ul=en-us&sr=1280x720&uaa=x86&uab=64&uafvl=Chromium%3B140.0.7339.185%7CNot%253DA%253FBrand%3B24.0.0.0%7CGoogle%2520Chrome%3B140.0.7339.185&uamb=0&uam=&uap=Windows&uapv=19.0.0&uaw=0&are=1&frm=0&pscdl=&_eu=AAAAAAQ&_s=1&tag_exp=101509157~103116026~103200004~103233427~104527906~104528500~104684208~104684211~104948813~115480710~115616986~115834636~115834638~115868795~115868797&sid=1759704706&sct=1&seg=1&dl=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse&dt=R%C3%B4le%20d%E2%80%99%C3%A9valuation%20fonci%C3%A8re&en=page_view&tfd=5989

Request URL
https://montreal.ca/info-recherche/api/evaluation-fonciere/gem/streets?q=Rue+Bishop%2C+Arrondissement+de+Ville-Marie+%28Montr%C3%A9al%29&page=1&size=10

Request Method
GET
Status Code
304 Not Modified
Remote Address
104.18.6.89:443
Referrer Policy
strict-origin-when-cross-origin
Request URL
https://www.google-analytics.com/g/collect?v=2&tid=G-X85NG0G8NT&gtm=45je5a11v9134341101za200zb9134342162zd9134342162&_p=1759706936984&gcd=13l3l3l3l1l1&npa=0&dma=0&cid=1605043035.1759704688&ul=en-us&sr=1280x720&uaa=x86&uab=64&uafvl=Chromium%3B140.0.7339.185%7CNot%253DA%253FBrand%3B24.0.0.0%7CGoogle%2520Chrome%3B140.0.7339.185&uamb=0&uam=&uap=Windows&uapv=19.0.0&uaw=0&are=1&frm=0&pscdl=&_eu=AEEAAAQ&_s=2&tag_exp=101509157~103116026~103200004~103233427~104527906~104528500~104684208~104684211~104948813~115480710~115616986~115834636~115834638~115868795~115868797&sid=1759704706&sct=1&seg=1&dl=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse&dt=R%C3%B4le%20d%E2%80%99%C3%A9valuation%20fonci%C3%A8re&en=form_start&ep.form_id=%C2%ABR6%C2%BB&ep.form_name=&ep.form_destination=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse%2Fliste&epn.form_length=13&ep.first_field_id=radix-%C2%ABrc%C2%BB&ep.first_field_name=streetNameCombobox&ep.first_field_type=&epn.first_field_position=2&_et=9062&tfd=15071

after you click search and new page loads

Request URL
https://api.montreal.ca/api/city-services/citizen/v2/organisations?limit=100

Request Method
GET
Status Code
304 Not Modified
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://montreal.ca/_next/data/info-recherche-2-3-13/fr-CA/role-evaluation-fonciere.json

Request Method
GET
Status Code
200 OK
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://montreal.ca/_next/data/info-recherche-2-3-13/fr-CA/role-evaluation-fonciere.json

Request Method
GET
Status Code
200 OK
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://montreal.ca/_next/data/info-recherche-2-3-13/fr-CA/role-evaluation-fonciere/adresse.json

Request Method
GET
Status Code
200 OK
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://montreal.ca/info-recherche/_next/static/css/406ef883613c4fbc.css

Request Method
GET
Status Code
200 OK (from disk cache)
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://montreal.ca/info-recherche/_next/static/css/b184c00d65df50f6.css

Request Method
GET
Status Code
200 OK (from disk cache)
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://www.google-analytics.com/g/collect?v=2&tid=G-X85NG0G8NT&gtm=45je5a11v9134341101z89134342162za200zb9134342162zd9134342162&_p=1759709531675&gcd=13l3l3l3l1l1&npa=0&dma=0&cid=1605043035.1759704688&ul=en-us&sr=1280x720&uaa=x86&uab=64&uafvl=Chromium%3B140.0.7339.185%7CNot%253DA%253FBrand%3B24.0.0.0%7CGoogle%2520Chrome%3B140.0.7339.185&uamb=0&uam=&uap=Windows&uapv=19.0.0&uaw=0&are=1&frm=0&pscdl=&_eu=AAAAAAQ&_s=1&tag_exp=101509157~103116026~103200004~103233427~104527906~104528500~104573694~104684208~104684211~104948813~115480710~115616985~115834636~115834638&sid=1759709127&sct=2&seg=1&dl=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse%2Fliste&dr=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse&dt=R%C3%B4le%20d%E2%80%99%C3%A9valuation%20fonci%C3%A8re&en=page_view&tfd=5994

when you click on confirmed address

Request URL
https://montreal.ca/_next/data/info-recherche-2-3-13/fr-CA/role-evaluation-fonciere/adresse/liste.json

Request Method
GET
Status Code
200 OK
Remote Address
104.18.6.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://montreal.ca/info-recherche/_next/static/css/17b088d930ab19b4.css

Request Method
GET
Status Code
200 OK (from disk cache)
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://www.google-analytics.com/g/collect?v=2&tid=G-X85NG0G8NT&gtm=45je5a11v9134341101z89134342162za200zb9134342162zd9134342162&_p=1759709701553&gcd=13l3l3l3l1l1&npa=0&dma=0&cid=1605043035.1759704688&ul=en-us&sr=1280x720&uaa=x86&uab=64&uafvl=Chromium%3B140.0.7339.185%7CNot%253DA%253FBrand%3B24.0.0.0%7CGoogle%2520Chrome%3B140.0.7339.185&uamb=0&uam=&uap=Windows&uapv=19.0.0&uaw=0&are=1&frm=0&pscdl=&_eu=AAAAAAQ&_s=1&tag_exp=101509157~103116026~103200004~103233427~104527906~104528501~104573694~104684208~104684211~104948813~115480709~115834636~115834638&sid=1759709127&sct=2&seg=1&dl=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse%2Fliste%2Fresultat&dr=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse%2Fliste&dt=R%C3%B4le%20d%E2%80%99%C3%A9valuation%20fonci%C3%A8re&en=page_view&tfd=5789

FINAL URL WHERE THE ADRESSES AND DATA COMES FROM : Request URL
https://montreal.ca/_next/data/info-recherche-2-3-13/fr-CA/role-evaluation-fonciere/adresse/liste.json

Request Method
GET
Status Code
200 OK
Remote Address
104.18.6.89:443
Referrer Policy
strict-origin-when-cross-origin

—--------------------

ELEMENTS :

Numéro d immeuble :

<label data-test="label" id="«rt»" for="radix-«rs»" data-invalid="true">Numéro d'immeuble</label>

<div class="_TextInput-small_o1hr5_21 input-group-icon"><input data-test="input" required="" maxlength="6" pattern="^[0-9]{1,5}([a-zA-Z]{0,1})$" title="" id="radix-«rs»" class="form-control is-invalid" name="civicNumber" aria-describedby="radix-«ru» radix-«r15»" fdprocessedid="8nk3al" data-gtm-form-interact-field-id="1" data-invalid="true"><button type="button" data-test="clear" hidden="" class="btn-clear"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-x-circle"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Supprimer le texte saisi</span></button></div> <input data-test="input" required="" maxlength="6" pattern="^[0-9]{1,5}([a-zA-Z]{0,1})$" title="" id="radix-«rs»" class="form-control is-invalid" name="civicNumber" aria-describedby="radix-«ru» radix-«r15»" fdprocessedid="8nk3al" data-gtm-form-interact-field-id="1" data-invalid="true">

<span id="radix-«r15»" data-test="invalid" class="invalid-feedback is-invalid"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-xs icon-exclamation"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Erreur</span>Le numéro d'immeuble est requis.</span>

Nom de la rue :

<span id="radix-«r11»" data-test="help" class="form-text">Entrez le nom de la rue et faites une sélection.</span>

<div data-test="combobox" class="_Root_1ssad_1"><div class="input-group-icon input-group-icon-left"><input data-test="input" required="" aria-busy="false" role="combobox" autocomplete="off" aria-autocomplete="list" aria-haspopup="true" aria-expanded="false" title="" id="radix-«rv»" class="form-control is-invalid" value="" name="streetNameCombobox" fdprocessedid="os361qh" data-gtm-form-interact-field-id="2" data-invalid="true"><span data-test="icon" aria-hidden="true" class="icon icon-color-neutral-stroke icon-search"></span><button type="button" data-test="clear" hidden="" class="btn-clear"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-x-circle"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Supprimer le texte saisi</span></button></div><div data-test="listbox" class="_Content_1ssad_15 dropdown-menu _Root_1lysn_1" style="top: auto; bottom: 100%; max-height: calc(437.333px - 0.5rem);"></div><input type="hidden" value="" name="streetGeneric"><input type="hidden" value="" name="streetName"><input type="hidden" value="" name="noCity"><input type="hidden" value="" name="boroughNumber"><input type="hidden" value="" name="streetNameOfficial"></div> <div class="input-group-icon input-group-icon-left"><input data-test="input" required="" aria-busy="false" role="combobox" autocomplete="off" aria-autocomplete="list" aria-haspopup="true" aria-expanded="false" title="" id="radix-«rv»" class="form-control is-invalid" value="" name="streetNameCombobox" fdprocessedid="os361qh" data-gtm-form-interact-field-id="2" data-invalid="true"><span data-test="icon" aria-hidden="true" class="icon icon-color-neutral-stroke icon-search"></span><button type="button" data-test="clear" hidden="" class="btn-clear"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-x-circle"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Supprimer le texte saisi</span></button></div> <input data-test="input" required="" aria-busy="false" role="combobox" autocomplete="off" aria-autocomplete="list" aria-haspopup="true" aria-expanded="false" title="" id="radix-«rv»" class="form-control is-invalid" value="" name="streetNameCombobox" fdprocessedid="os361qh" data-gtm-form-interact-field-id="2" data-invalid="true">

cliquer sur bouton rechercher :

<button data-test="submit" form="«R6»" type="submit" class="btn-squared btn btn-primary" fdprocessedid="zlzwzw">Rechercher</button>

sélectionner une adresse : cliquer sur adresse

<dl class="dl-list separator"><dt>Adresse</dt><dd>1463 Rue Bishop (Montréal)</dd></dl> <ul data-test="list-group" class="_Root_piya8_1 list-group list-group-teaser list-group-complex"><li data-test="item" tabindex="0" class="focus:informative list-group-item list-group-item-action" role="listitem"><div class="row no-gutters"><div class="col"><div class="row no-gutters"><div class="col"><div data-test="title" class="list-group-item-title"><dl class="dl-list separator"><dt>Adresse</dt><dd>1463 Rue Bishop (Montréal)</dd></dl></div><div data-test="content" class="list-group-item-content empty-placeholder"><dl class="dl-list separator font:sm"><div><dt>Numéro de compte foncier</dt><dd>30 - F26131400</dd></div><div><dt>Numéro de matricule</dt><dd>9839-77-3228-4-000-0000</dd></div></dl></div></div></div></div><div class="col-auto ml-2"><div data-test="action-list" class="list-group-actions"><form method="post" action="/role-evaluation-fonciere/adresse/liste/resultat"><input type="hidden" value="1036820" name="evalUnitId"><button data-test="button" type="submit" class="btn-squared btn-icon btn btn-link"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-chevron-right"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Soumettre</span></button></form></div></div></div></li></ul> <li data-test="item" tabindex="0" class="focus:informative list-group-item list-group-item-action" role="listitem"><div class="row no-gutters"><div class="col"><div class="row no-gutters"><div class="col"><div data-test="title" class="list-group-item-title"><dl class="dl-list separator"><dt>Adresse</dt><dd>1463 Rue Bishop (Montréal)</dd></dl></div><div data-test="content" class="list-group-item-content empty-placeholder"><dl class="dl-list separator font:sm"><div><dt>Numéro de compte foncier</dt><dd>30 - F26131400</dd></div><div><dt>Numéro de matricule</dt><dd>9839-77-3228-4-000-0000</dd></div></dl></div></div></div></div><div class="col-auto ml-2"><div data-test="action-list" class="list-group-actions"><form method="post" action="/role-evaluation-fonciere/adresse/liste/resultat"><input type="hidden" value="1036820" name="evalUnitId"><button data-test="button" type="submit" class="btn-squared btn-icon btn btn-link"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-chevron-right"></span><span style="position: absolute; border: 0px; width: 1px; height: 1 px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Soumettre</span></button></form></div></div></div></li> <div class="row no-gutters"><div class="col"><div class="row no-gutters"><div class="col"><div data-test="title" class="list-group-item-title"><dl class="dl-list separator"><dt>Adresse</dt><dd>1463 Rue Bishop (Montréal)</dd></dl></div><div data-test="content" class="list-group-item-content empty-placeholder"><dl class="dl-list separator font:sm"><div><dt>Numéro de compte foncier</dt><dd>30 - F26131400</dd></div><div><dt>Numéro de matricule</dt><dd>9839-77-3228-4-000-0000</dd></div></dl></div></div></div></div><div class="col-auto ml-2"><div data-test="action-list" class="list-group-actions"><form method="post" action="/role-evaluation-fonciere/adresse/liste/resultat"><input type="hidden" value="1036820" name="evalUnitId"><button data-test="button" type="submit" class="btn-squared btn-icon btn btn-link"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-chevron-right"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Soumettre</span></button></form></div></div></div> <div class="col"><div class="row no-gutters"><div class="col"><div data-test="title" class="list-group-item-title"><dl class="dl-list separator"><dt>Adresse</dt><dd>1463 Rue Bishop (Montréal)</dd></dl></div><div data-test="content" class="list-group-item-content empty-placeholder"><dl class="dl-list separator font:sm"><div><dt>Numéro de compte foncier</dt><dd>30 - F26131400</dd></div><div><dt>Numéro de matricule</dt><dd>9839-77-3228-4-000-0000</dd></div></dl></div></div></div></div> <div class="col-auto ml-2"><div data-test="action-list" class="list-group-actions"><form method="post" action="/role-evaluation-fonciere/adresse/liste/resultat"><input type="hidden" value="1036820" name="evalUnitId"><button data-test="button" type="submit" class="btn-squared btn-icon btn btn-link"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-chevron-right"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Soumettre</span></button></form></div></div></div>

<button data-test="submit" form="«R6»" type="submit" class="btn-squared btn btn-primary" fdprocessedid="zlzwzw">Rechercher</button>

end page with relevant data (owner info, etc…)

{ … (keep the big JSON with sections/owners/caracteristiques/etc exactly as you shared) … }

To login into account :

where to click when entering montreal.ca

<button type="button" class="btn navbar-btn navbar-btn-icon btn-login btn-hide-label-md d-lg-inline-flex" id="shell-login-button" aria-label="Mon compte"><span class="icon icon-user-circle" aria-hidden="true"></span><span class="btn-label">Mon compte</span></button>

<span class="icon icon-user-circle" aria-hidden="true"></span>

<span class="btn-label">Mon compte</span>

where to enter email :

<input type="text" id="signInName" autofocus="" aria-describedby="signInName-error" fdprocessedid="xqic1a">

where to enter password :

<input type="password" id="password" autocomplete="current-password" aria-required="true" aria-describedby="password-error" fdprocessedid="3o0tfw">

where to click after putting login info to login :

<button id="next" type="submit" form="localAccountForm" fdprocessedid="pmstej">Me connecter</button>

Final note for Codex

Generate all files, wire the CLI, and make sure CSV overwrite + Sheets update in-row + snapshot export are working out of the box.

Add README.md explaining Google service account setup and Playwright install (playwright install).

Include unit tests for parsers.py (given the selectors) with sample HTML snippets.


================================================================================
FOLDER: root
================================================================================

--------------------------------------------------------------------------------
FILE: .env.example
STATUS: New
SIZE: 191 Bytes | LINES: 10
--------------------------------------------------------------------------------
# Montreal role scraper configuration
MONTREAL_EMAIL=
MONTREAL_PASSWORD=
GOOGLE_SERVICE_ACCOUNT_JSON=
SHEET_NAME=
SHEET_TAB=
DELAY_MIN=1.5
DELAY_MAX=3.0
CACHE_PATH=cache.sqlite
LOG_LEVEL=INFO

--------------------------------------------------------------------------------
FILE: main.py
STATUS: New
SIZE: 11.79 KB | LINES: 332
--------------------------------------------------------------------------------
import argparse
import json
import logging
import os
import time
from pathlib import Path
from typing import Dict, List, Tuple

from dotenv import load_dotenv

from scraper.browser import launch_browser, new_page
from scraper.cache import Cache
from scraper.csvio import (
    backup_original,
    ensure_output_columns,
    export_snapshot,
    read_csv,
    write_csv,
)
from scraper.schema import BOROUGH_COLUMN, OUTPUT_COLUMNS
from scraper.log import configure_logging
from scraper.montreal_role import MontrealRoleScraper, parse_input_row
from scraper.rate import RateLimiter
from scraper.sheets import (
    SheetConfig,
    batch_update,
    ensure_columns,
    get_client,
    open_sheet,
    range_for_rows,
)


logger = logging.getLogger(__name__)


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(description="Montreal role scraper")
    parser.add_argument("--csv", type=str, help="Path to CSV file")
    parser.add_argument("--sheet", type=str, help="Google Sheet name")
    parser.add_argument("--tab", type=str, help="Google Sheet tab name")
    parser.add_argument("--from-row", type=int, default=2, help="Starting row (1-indexed)")
    parser.add_argument("--max", type=int, default=0, help="Maximum rows to process")
    parser.add_argument("--delay-min", type=float, default=1.5)
    parser.add_argument("--delay-max", type=float, default=3.0)
    parser.add_argument("--headful", action="store_true", help="Run browser headful")
    parser.add_argument("--login", action="store_true", help="Use login flow")
    return parser.parse_args()


def main() -> None:
    load_dotenv()
    args = parse_args()
    configure_logging(level=os.getenv("LOG_LEVEL", "INFO"))

    sheet_name = args.sheet or os.getenv("SHEET_NAME")
    sheet_tab = args.tab or os.getenv("SHEET_TAB")

    if args.csv and sheet_name:
        raise SystemExit("Specify either --csv or --sheet")
    if not args.csv and not sheet_name:
        raise SystemExit("Specify either --csv or --sheet")

    if not args.csv:
        args.sheet = sheet_name
        args.tab = sheet_tab
        if not args.sheet or not args.tab:
            raise SystemExit("Both --sheet and --tab (or SHEET_NAME/SHEET_TAB) are required")

    cache_path = Path(os.getenv("CACHE_PATH", "cache.sqlite"))
    rate_limiter = RateLimiter(delay_min=args.delay_min, delay_max=args.delay_max)
    cache = Cache(cache_path)
    try:
        with launch_browser(headless=not args.headful) as (_, _, context):
            page = new_page(context)
            login_email = os.getenv("MONTREAL_EMAIL")
            login_password = os.getenv("MONTREAL_PASSWORD")
            scraper = MontrealRoleScraper(
                page=page,
                cache=cache,
                rate_limiter=rate_limiter,
                login_email=login_email,
                login_password=login_password,
            )
            if args.login:
                if not login_email or not login_password:
                    raise SystemExit("Missing MONTREAL_EMAIL or MONTREAL_PASSWORD in environment")
                scraper.login(login_email, login_password)

            if args.csv:
                process_csv(Path(args.csv), scraper, args)
            else:
                process_sheet(args, scraper)
    finally:
        cache.close()


def process_csv(path: Path, scraper: MontrealRoleScraper, args):
    df = read_csv(path)
    backup_original(path, df.copy())
    start_index = max(0, args.from_row - 2)
    processed = 0
    failures: List[Tuple[int, str]] = []
    borough_present = BOROUGH_COLUMN in df.columns
    if not borough_present:
        logger.warning(
            "Column '%s' not found in CSV; borough-aware selection will be skipped",
            BOROUGH_COLUMN,
        )
    for idx in range(start_index, len(df)):
        if args.max and processed >= args.max:
            break
        row = df.iloc[idx].to_dict()
        row = ensure_output_columns(row)
        query = parse_input_row(row)
        status = "error:missing_address"
        result: Dict[str, str] = {}
        if query and not query.borough and borough_present:
            logger.debug(
                "Row %s missing borough value in '%s'; falling back to address-only matching",
                idx + 1,
                BOROUGH_COLUMN,
            )
        if not query:
            logger.warning("Skipping row %s due to missing address fields", idx + 1)
        else:
            result = scraper.fetch(query) or {}
            status = result.get("status", "error:unknown")
        if status == "ok":
            for key in OUTPUT_COLUMNS:
                df.at[idx, key] = result.get(key, "")
        else:
            df.at[idx, "status"] = status
            failures.append((idx + 1, status))
        processed += 1
    if failures:
        for row_number, failure_status in failures:
            logger.warning("Row %s not updated due to status '%s'", row_number, failure_status)
    write_csv(path, df)
    enriched_path = path.with_name(f"{path.stem}_enriched{path.suffix}")
    df.to_csv(enriched_path, index=False)
    export_snapshot(df, Path("exports"))


def process_sheet(args, scraper: MontrealRoleScraper) -> None:
    service_json = os.getenv("GOOGLE_SERVICE_ACCOUNT_JSON", "")
    if not service_json:
        raise SystemExit("GOOGLE_SERVICE_ACCOUNT_JSON must be set for Sheets mode")
    client = get_client(service_json)
    config = SheetConfig(spreadsheet=args.sheet, tab=args.tab, from_row=args.from_row)
    ws = open_sheet(client, config)
    header = ensure_columns(ws)
    borough_present = BOROUGH_COLUMN in header
    if not borough_present:
        logger.warning(
            "Column '%s' not found in Sheet header; borough-aware selection will be skipped",
            BOROUGH_COLUMN,
        )

    all_values = ws.get_all_values()
    start_row_idx = config.from_row - 1
    processed = 0
    success_rows: List[Tuple[int, Dict[str, str], Dict[str, str]]] = []
    failure_statuses: List[Tuple[int, str]] = []
    for row_idx in range(start_row_idx, len(all_values)):
        if args.max and processed >= args.max:
            break
        row_number = row_idx + 1
        row_values = all_values[row_idx]
        row_dict = {header[i]: row_values[i] if i < len(row_values) else "" for i in range(len(header))}
        row_dict = ensure_output_columns(row_dict)
        query = parse_input_row(row_dict)
        status = "error:missing_address"
        result: Dict[str, str] = {}
        if query and not query.borough and borough_present:
            logger.debug(
                "Row %s missing borough value in '%s'; using address-only matching",
                row_number,
                BOROUGH_COLUMN,
            )
        if not query:
            logger.warning("Skipping row %s due to missing address fields", row_number)
        else:
            result = scraper.fetch(query) or {}
            status = result.get("status", "error:unknown")
        if status == "ok":
            original_row = row_dict.copy()
            updated_row = row_dict.copy()
            for key in OUTPUT_COLUMNS:
                updated_row[key] = result.get(key, "")
            success_rows.append((row_number, original_row, updated_row))
            if len(success_rows) >= 20:
                _commit_batch(ws, success_rows, header)
                success_rows = []
        else:
            logger.warning(
                "Row %s not updated due to status '%s'", row_number, status
            )
            failure_statuses.append((row_number, status))
            if success_rows:
                _commit_batch(ws, success_rows, header)
                success_rows = []
        processed += 1
    if success_rows:
        _commit_batch(ws, success_rows, header)
    if failure_statuses:
        _apply_status_updates(ws, header, failure_statuses)


def _commit_batch(
    ws,
    indexed_rows: List[Tuple[int, Dict[str, str], Dict[str, str]]],
    header: List[str],
) -> None:
    if not indexed_rows:
        return
    ordered = sorted(indexed_rows, key=lambda item: item[0])
    current_start: int = -1
    current_rows: List[Tuple[int, Dict[str, str], Dict[str, str]]] = []
    previous_row: int = -1

    def _dispatch(start: int, rows: List[Tuple[int, Dict[str, str], Dict[str, str]]]) -> None:
        if not rows:
            return
        updated_payload = [updated for (_, _, updated) in rows]
        try:
            batch_update(ws, start, updated_payload, header)
        except Exception as exc:
            end_row = start + len(rows) - 1
            range_label = range_for_rows(start, len(rows), header)
            logger.warning(
                "sheets.batch_failure %s",
                json.dumps({
                    "start_row": start,
                    "end_row": end_row,
                    "range": range_label,
                    "error": str(exc),
                }),
            )
            snapshot = None
            if hasattr(ws, "get"):
                try:
                    snapshot = ws.get(range_label)
                except Exception as fetch_exc:
                    logger.debug(
                        "Unable to snapshot rows %s-%s prior to rollback: %s",
                        start,
                        end_row,
                        fetch_exc,
                    )
            if snapshot is not None:
                logger.info(
                    "sheets.snapshot %s",
                    json.dumps({
                        "range": range_label,
                        "values": snapshot,
                    }),
                )
            original_payload = [original for (_, original, _) in rows]
            try:
                batch_update(ws, start, original_payload, header)
            except Exception as rollback_exc:
                logger.error(
                    "Rollback failed for rows %s-%s: %s",
                    start,
                    end_row,
                    rollback_exc,
                )
                raise
            logger.info(
                "sheets.rollback %s",
                json.dumps({
                    "start_row": start,
                    "end_row": end_row,
                    "range": range_label,
                }),
            )
            time.sleep(2)
            try:
                batch_update(ws, start, updated_payload, header)
            except Exception as final_exc:
                logger.error(
                    "Batch update retry failed for rows %s-%s: %s",
                    start,
                    end_row,
                    final_exc,
                )
                raise

    for row_number, original, updated in ordered:
        if not current_rows:
            current_start = row_number
            current_rows = [(row_number, original, updated)]
        elif row_number == previous_row + 1:
            current_rows.append((row_number, original, updated))
        else:
            _dispatch(current_start, current_rows)
            current_start = row_number
            current_rows = [(row_number, original, updated)]
        previous_row = row_number
    _dispatch(current_start, current_rows)


def _apply_status_updates(ws, header: List[str], updates: List[Tuple[int, str]]) -> None:
    if not updates:
        return
    try:
        status_col_index = header.index("status") + 1
    except ValueError:
        logger.error("Status column missing from header; cannot record failures")
        return
    try:
        from gspread.utils import rowcol_to_a1
    except ImportError:
        logger.error("gspread is required to update status cells")
        return

    for row_number, status in updates:
        cell = rowcol_to_a1(row_number, status_col_index)
        try:
            ws.update(cell, [[status]])
        except Exception as exc:
            logger.error(
                "Failed to update status for row %s at %s: %s",
                row_number,
                cell,
                exc,
            )


if __name__ == "__main__":
    main()

--------------------------------------------------------------------------------
FILE: requirements.txt
STATUS: New
SIZE: 76 Bytes | LINES: 8
--------------------------------------------------------------------------------
playwright
pandas
gspread
google-auth
python-dotenv
tenacity
rich
selectolax

--------------------------------------------------------------------------------
FILE: .example
STATUS: New
SIZE: 27.95 KB | LINES: 515
--------------------------------------------------------------------------------
# Montreal role scraper configuration
MONTREAL_EMAIL=
MONTREAL_PASSWORD=
GOOGLE_SERVICE_ACCOUNT_JSON=
SHEET_NAME=
SHEET_TAB=
DELAY_MIN=1.5
DELAY_MAX=3.0
CACHE_PATH=cache.sqlite
LOG_LEVEL=INFO
.github/codeql/codeql-config.yml
New
+6
-0

name: python-codeql
paths:
  - main.py
  - scraper
  - selectolax
  - tests
.github/workflows/codeql.yml
New
+50
-0

name: CodeQL

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: '0 0 * * 0'

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Python sources
        id: detect_python
        run: |
          files="$(git ls-files '*.py')"
          if [ -n "$files" ]; then
            echo "has_python=true" >> "$GITHUB_OUTPUT"
          else
            echo "No Python sources detected; skipping CodeQL." >> "$GITHUB_STEP_SUMMARY"
            echo "has_python=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Initialize CodeQL
        if: steps.detect_python.outputs.has_python == 'true'
        uses: github/codeql-action/init@v3
        with:
          languages: python
          config-file: ./.github/codeql/codeql-config.yml

      - name: Autobuild
        if: steps.detect_python.outputs.has_python == 'true'
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        if: steps.detect_python.outputs.has_python == 'true'
        uses: github/codeql-action/analyze@v3
README.md
+430
-1

# SELENIUM-AUTOMATION-FOR-OWNER-NAME
# Montréal Role d'évaluation Scraper

This project automates the Montréal Rôle d’évaluation foncière workflow for CSV or Google Sheets inputs. It enriches rows with owner and assessment data while respecting ToS-friendly scraping practices (rate limiting, retries, and stealth browser behaviors).

## Features

- Playwright (Chromium) automation with basic stealth evasion.
- Supports CSV and Google Sheets sources via a unified CLI.
- Retries with exponential backoff and jittered delays between requests.
- SQLite cache prevents duplicate work on re-runs.
- Deterministic output schema appended to each data source.
- Atomic CSV overwrites, timestamped backups, and snapshot exports.
- Google Sheets batching with rollback-aware retry handling.
- Structured logging to console and `logs/run.log`.

## Requirements

- Python 3.11
- Playwright dependencies (Chromium browser binaries)

Install Python dependencies:

```bash
pip install -r requirements.txt
playwright install
```

## Environment Variables

Copy `.env.example` to `.env` and fill in the values:

| Variable | Description |
| --- | --- |
| `MONTREAL_EMAIL` | Optional: account email used when `--login` is supplied. |
| `MONTREAL_PASSWORD` | Optional: password for the Montréal account. |
| `GOOGLE_SERVICE_ACCOUNT_JSON` | Path to a Google service account JSON file or the JSON string itself. Required for Sheets mode. |
| `SHEET_NAME` / `SHEET_TAB` | Defaults for CLI flags. |
| `DELAY_MIN` / `DELAY_MAX` | Default jitter window (seconds). |
| `CACHE_PATH` | Path to the SQLite cache file. |
| `LOG_LEVEL` | Logging verbosity (e.g., `INFO`). |

## Google Sheets Setup

1. Create a Google Cloud project and enable the Sheets API.
2. Generate a service account with the "Editor" role.
3. Download the service account JSON and share your spreadsheet with the service account email.
4. Provide the JSON file path (or inline JSON string) via `GOOGLE_SERVICE_ACCOUNT_JSON`.

## CLI Usage

```bash
python main.py --csv ./input/mtl_targets.csv --max 250 --delay-min 1.5 --delay-max 3.0
python main.py --sheet "MTL Plex Leads" --tab "20-40" --from-row 2
python main.py --csv ./input/mtl_targets.csv --headful
python main.py --sheet "MTL Plex Leads" --tab "20-40" --login
```

## Configuring Git remotes for PR automation

This repository does not ship with a Git remote preconfigured. Tools that
attempt to open pull requests (including the provided `make_pr` helper)
require an upstream remote/branch to compare against. If you see errors such
as “no remote configured” or `fatal: No such remote: 'origin'`, add the
appropriate remote before re-running the tool:

```bash
git remote add origin https://github.com/MugiZer/SELENIUM-AUTOMATION-FOR-OWNER-NAME.git
git push -u origin work   # replace `work` with your current branch name
```

If you already have a different remote configured, you can update it instead:

```bash
git remote set-url origin https://github.com/MugiZer/SELENIUM-AUTOMATION-FOR-OWNER-NAME.git
```

After the first push, subsequent PR attempts will succeed because Git knows
which remote branch should receive updates.

### Manual pull request checklist

If you prefer creating the pull request through the GitHub UI (or need to
recover from a failed attempt), run the following commands locally. Replace
`<branch>` with the branch that contains your changes — you can always check it
with `git branch --show-current`.

```bash
# make sure all work is committed before switching
git status

# create or switch to the feature branch if necessary
git checkout -b <branch>        # or: git checkout <branch> if it already exists

# verify which branch you are on
git branch --show-current

# ensure the remote points to the public repository
git remote -v
git remote add origin https://github.com/MugiZer/SELENIUM-AUTOMATION-FOR-OWNER-NAME.git  # only if 'origin' is missing
git remote set-url origin https://github.com/MugiZer/SELENIUM-AUTOMATION-FOR-OWNER-NAME.git  # only if it points elsewhere

# publish the branch and establish the upstream tracking reference
git push -u origin <branch>
```

After the push completes, open the repository page in your browser and click
**Compare & pull request**. GitHub will pre-fill the base branch (`main`) and the
compare branch (`<branch>`). Review the diff, add a title/description, and submit
the PR. Future pushes to the same branch require only `git push` because the
upstream tracking relationship is already in place.

### Borough reference

The dataset must include a column containing the authoritative borough name for each address. The column name is `NO_ARROND_ILE_CUM` and each cell must match one of the following values exactly:

- Arrondissement de Villeray - Saint-Michel - Parc-Extension (Montréal)
- (Westmount)
- Arrondissement du Plateau-Mont-Royal (Montréal)
- Arrondissement du Sud-Ouest (Montréal)
- Arrondissement de Ville-Marie (Montréal)
- Arrondissement de Côte-des-Neiges - Notre-Dame-de-Grâce (Montréal)
- Saint Leonard
- Arrondissement de Lachine (Montréal)
- Arrondissement de Verdun (Montréal)
- Arrondissement de Rosemont - La Petite-Patrie
- Arrondissement de Pierrefonds - Roxboro (Montréal)
- Arrondissement d'Outremont (Montréal)
- Arrondissement de Saint-Laurent (Montréal)
- Arrondissement d'Ahuntsic-Cartierville
- Arrondissement de Mercier - Hochelaga-Maisonneuve (Montréal)

During scraping the list view may contain duplicate street names. The scraper uses the normalised value from `NO_ARROND_ILE_CUM` to pick the matching borough entry; when the column is missing or blank the workflow gracefully falls back to address-only matching and logs the loss of precision so operators can correct the dataset.

### Output Columns

Each processed row gains the following columns:

- `owner_names`
- `owner_type`
- `matricule`
- `tax_account_number`
- `municipality`
- `fiscal_years`
- `nb_logements`
- `assessed_terrain_current`
- `assessed_batiment_current`
- `assessed_total_current`
- `assessed_total_previous`
- `tax_distribution_json`
- `last_fetched_at`
- `source_url`
- `status`

## Logging

Logs are written to stdout and `logs/run.log` via a rotating handler. Adjust verbosity with the `LOG_LEVEL` environment variable.

## Testing

Unit tests cover the HTML parser logic:

```bash
pytest
```

## Troubleshooting

- **Playwright missing browsers**: run `playwright install`.
- **Authentication failures**: ensure `MONTREAL_EMAIL` and `MONTREAL_PASSWORD` are set and valid.
- **Sheets authentication**: confirm the spreadsheet is shared with the service account email and the JSON credentials are correct.
- **429 or 5xx responses**: the scraper retries automatically with exponential backoff while keeping rate limits.
- **Borough mismatches**: verify `NO_ARROND_ILE_CUM` values match the canonical list exactly; typos force the scraper to fall back to
  address-only matching and return a `multiple_matches` or `not_found` status.

## Appendix: DevTools Data (verbatim)

The following section is reproduced verbatim from the project brief to ensure selector fidelity.

✳️ DEVTOOLS DATA (append EXACTLY, do not modify)

https://montreal.ca/role-evaluation-fonciere/adresse

API NETWORK :

1)When we fill numéro d immeuble :

Request URL
https://www.google-analytics.com/g/collect?v=2&tid=G-X85NG0G8NT&gtm=45je5a11v9134341101z89134342162za200zb9134342162zd9134342162&_p=1759709177686&gcd=13l3l3l3l1l1&npa=0&dma=0&cid=1605043035.1759704688&ul=en-us&sr=1280x720&uaa=x86&uab=64&uafvl=Chromium%3B140.0.7339.185%7CNot%253DA%253FBrand%3B24.0.0.0%7CGoogle%2520Chrome%3B140.0.7339.185&uamb=0&uam=&uap=Windows&uapv=19.0.0&uaw=0&are=1&frm=0&pscdl=&_eu=AAAAAAQ&_s=1&tag_exp=101509157~103116026~103200004~103233427~104527907~104528500~104573694~104684208~104684211~104948813~115480710~115834636~115834638&sid=1759709127&sct=2&seg=1&dl=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse&dt=R%C3%B4le%20d%E2%80%99%C3%A9valuation%20fonci%C3%A8re&en=page_view&tfd=5478

Request Method
POST
Status Code
204 No Content
Remote Address
142.250.69.46:443
Referrer Policy
strict-origin-when-cross-origin
Request URL
https://www.google-analytics.com/g/collect?v=2&tid=G-X85NG0G8NT&gtm=45je5a11v9134341101za200zb9134342162zd9134342162&_p=1759709177686&gcd=13l3l3l3l1l1&npa=0&dma=0&cid=1605043035.1759704688&ul=en-us&sr=1280x720&uaa=x86&uab=64&uafvl=Chromium%3B140.0.7339.185%7CNot%253DA%253FBrand%3B24.0.0.0%7CGoogle%2520Chrome%3B140.0.7339.185&uamb=0&uam=&uap=Windows&uapv=19.0.0&uaw=0&are=1&frm=0&pscdl=&_eu=AEEAAAQ&_s=2&tag_exp=101509157~103116026~103200004~103233427~104527907~104528500~104573694~104684208~104684211~104948813~115480710~115834636~115834638&sid=1759709127&sct=2&seg=1&dl=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse&dt=R%C3%B4le%20d%E2%80%99%C3%A9valuation%20fonci%C3%A8re&en=form_start&ep.form_id=%C2%ABR6%C2%BB&ep.form_name=&ep.form_destination=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse%2Fliste&epn.form_length=13&ep.first_field_id=radix-%C2%ABr9%C2%BB&ep.first_field_name=civicNumber&ep.first_field_type=&epn.first_field_position=1&_et=4612&tfd=10492

2)when we fill Nom de la rue :
Request URL
https://montreal.ca/_next/data/info-recherche-2-3-13/fr-CA/role-evaluation-fonciere.json

Request Method
GET
Status Code
200 OK
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin
Request URL
https://montreal.ca/info-recherche/_next/static/css/406ef883613c4fbc.css

Request Method
GET
Status Code
200 OK (from disk cache)
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin
equest URL
https://montreal.ca/info-recherche/api/evaluation-fonciere/gem/streets?q=Bishop&page=1&size=10

Request Method
GET
Status Code
304 Not Modified
Remote Address
104.18.6.89:443
Referrer Policy
strict-origin-when-cross-origin
Request URL
https://www.google-analytics.com/g/collect?v=2&tid=G-X85NG0G8NT&gtm=45je5a11v9134341101z89134342162za200zb9134342162zd9134342162&_p=1759706936984&gcd=13l3l3l3l1l1&npa=0&dma=0&cid=1605043035.1759704688&ul=en-us&sr=1280x720&uaa=x86&uab=64&uafvl=Chromium%3B140.0.7339.185%7CNot%253DA%253FBrand%3B24.0.0.0%7CGoogle%2520Chrome%3B140.0.7339.185&uamb=0&uam=&uap=Windows&uapv=19.0.0&uaw=0&are=1&frm=0&pscdl=&_eu=AAAAAAQ&_s=1&tag_exp=101509157~103116026~103200004~103233427~104527906~104528500~104684208~104684211~104948813~115480710~115616986~115834636~115834638~115868795~115868797&sid=1759704706&sct=1&seg=1&dl=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse&dt=R%C3%B4le%20d%E2%80%99%C3%A9valuation%20fonci%C3%A8re&en=page_view&tfd=5989

Request URL
https://montreal.ca/info-recherche/api/evaluation-fonciere/gem/streets?q=Rue+Bishop%2C+Arrondissement+de+Ville-Marie+%28Montr%C3%A9al%29&page=1&size=10

Request Method
GET
Status Code
304 Not Modified
Remote Address
104.18.6.89:443
Referrer Policy
strict-origin-when-cross-origin
Request URL
https://www.google-analytics.com/g/collect?v=2&tid=G-X85NG0G8NT&gtm=45je5a11v9134341101za200zb9134342162zd9134342162&_p=1759706936984&gcd=13l3l3l3l1l1&npa=0&dma=0&cid=1605043035.1759704688&ul=en-us&sr=1280x720&uaa=x86&uab=64&uafvl=Chromium%3B140.0.7339.185%7CNot%253DA%253FBrand%3B24.0.0.0%7CGoogle%2520Chrome%3B140.0.7339.185&uamb=0&uam=&uap=Windows&uapv=19.0.0&uaw=0&are=1&frm=0&pscdl=&_eu=AEEAAAQ&_s=2&tag_exp=101509157~103116026~103200004~103233427~104527906~104528500~104684208~104684211~104948813~115480710~115616986~115834636~115834638~115868795~115868797&sid=1759704706&sct=1&seg=1&dl=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse&dt=R%C3%B4le%20d%E2%80%99%C3%A9valuation%20fonci%C3%A8re&en=form_start&ep.form_id=%C2%ABR6%C2%BB&ep.form_name=&ep.form_destination=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse%2Fliste&epn.form_length=13&ep.first_field_id=radix-%C2%ABrc%C2%BB&ep.first_field_name=streetNameCombobox&ep.first_field_type=&epn.first_field_position=2&_et=9062&tfd=15071

after you click search and new page loads

Request URL
https://api.montreal.ca/api/city-services/citizen/v2/organisations?limit=100

Request Method
GET
Status Code
304 Not Modified
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://montreal.ca/_next/data/info-recherche-2-3-13/fr-CA/role-evaluation-fonciere.json

Request Method
GET
Status Code
200 OK
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://montreal.ca/_next/data/info-recherche-2-3-13/fr-CA/role-evaluation-fonciere.json

Request Method
GET
Status Code
200 OK
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://montreal.ca/_next/data/info-recherche-2-3-13/fr-CA/role-evaluation-fonciere/adresse.json

Request Method
GET
Status Code
200 OK
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://montreal.ca/info-recherche/_next/static/css/406ef883613c4fbc.css

Request Method
GET
Status Code
200 OK (from disk cache)
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://montreal.ca/info-recherche/_next/static/css/b184c00d65df50f6.css

Request Method
GET
Status Code
200 OK (from disk cache)
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://www.google-analytics.com/g/collect?v=2&tid=G-X85NG0G8NT&gtm=45je5a11v9134341101z89134342162za200zb9134342162zd9134342162&_p=1759709531675&gcd=13l3l3l3l1l1&npa=0&dma=0&cid=1605043035.1759704688&ul=en-us&sr=1280x720&uaa=x86&uab=64&uafvl=Chromium%3B140.0.7339.185%7CNot%253DA%253FBrand%3B24.0.0.0%7CGoogle%2520Chrome%3B140.0.7339.185&uamb=0&uam=&uap=Windows&uapv=19.0.0&uaw=0&are=1&frm=0&pscdl=&_eu=AAAAAAQ&_s=1&tag_exp=101509157~103116026~103200004~103233427~104527906~104528500~104573694~104684208~104684211~104948813~115480710~115616985~115834636~115834638&sid=1759709127&sct=2&seg=1&dl=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse%2Fliste&dr=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse&dt=R%C3%B4le%20d%E2%80%99%C3%A9valuation%20fonci%C3%A8re&en=page_view&tfd=5994

when you click on confirmed address

Request URL
https://montreal.ca/_next/data/info-recherche-2-3-13/fr-CA/role-evaluation-fonciere/adresse/liste.json

Request Method
GET
Status Code
200 OK
Remote Address
104.18.6.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://montreal.ca/info-recherche/_next/static/css/17b088d930ab19b4.css

Request Method
GET
Status Code
200 OK (from disk cache)
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://www.google-analytics.com/g/collect?v=2&tid=G-X85NG0G8NT&gtm=45je5a11v9134341101z89134342162za200zb9134342162zd9134342162&_p=1759709701553&gcd=13l3l3l3l1l1&npa=0&dma=0&cid=1605043035.1759704688&ul=en-us&sr=1280x720&uaa=x86&uab=64&uafvl=Chromium%3B140.0.7339.185%7CNot%253DA%253FBrand%3B24.0.0.0%7CGoogle%2520Chrome%3B140.0.7339.185&uamb=0&uam=&uap=Windows&uapv=19.0.0&uaw=0&are=1&frm=0&pscdl=&_eu=AAAAAAQ&_s=1&tag_exp=101509157~103116026~103200004~103233427~104527906~104528501~104573694~104684208~104684211~104948813~115480709~115834636~115834638&sid=1759709127&sct=2&seg=1&dl=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse%2Fliste%2Fresultat&dr=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse%2Fliste&dt=R%C3%B4le%20d%E2%80%99%C3%A9valuation%20fonci%C3%A8re&en=page_view&tfd=5789

FINAL URL WHERE THE ADRESSES AND DATA COMES FROM : Request URL
https://montreal.ca/_next/data/info-recherche-2-3-13/fr-CA/role-evaluation-fonciere/adresse/liste.json

Request Method
GET
Status Code
200 OK
Remote Address
104.18.6.89:443
Referrer Policy
strict-origin-when-cross-origin

—--------------------

ELEMENTS :

Numéro d immeuble :

<label data-test="label" id="«rt»" for="radix-«rs»" data-invalid="true">Numéro d'immeuble</label>

<div class="_TextInput-small_o1hr5_21 input-group-icon"><input data-test="input" required="" maxlength="6" pattern="^[0-9]{1,5}([a-zA-Z]{0,1})$" title="" id="radix-«rs»" class="form-control is-invalid" name="civicNumber" aria-describedby="radix-«ru» radix-«r15»" fdprocessedid="8nk3al" data-gtm-form-interact-field-id="1" data-invalid="true"><button type="button" data-test="clear" hidden="" class="btn-clear"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-x-circle"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Supprimer le texte saisi</span></button></div> <input data-test="input" required="" maxlength="6" pattern="^[0-9]{1,5}([a-zA-Z]{0,1})$" title="" id="radix-«rs»" class="form-control is-invalid" name="civicNumber" aria-describedby="radix-«ru» radix-«r15»" fdprocessedid="8nk3al" data-gtm-form-interact-field-id="1" data-invalid="true">

<span id="radix-«r15»" data-test="invalid" class="invalid-feedback is-invalid"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-xs icon-exclamation"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Erreur</span>Le numéro d'immeuble est requis.</span>

Nom de la rue :

<span id="radix-«r11»" data-test="help" class="form-text">Entrez le nom de la rue et faites une sélection.</span>

<div data-test="combobox" class="_Root_1ssad_1"><div class="input-group-icon input-group-icon-left"><input data-test="input" required="" aria-busy="false" role="combobox" autocomplete="off" aria-autocomplete="list" aria-haspopup="true" aria-expanded="false" title="" id="radix-«rv»" class="form-control is-invalid" value="" name="streetNameCombobox" fdprocessedid="os361qh" data-gtm-form-interact-field-id="2" data-invalid="true"><span data-test="icon" aria-hidden="true" class="icon icon-color-neutral-stroke icon-search"></span><button type="button" data-test="clear" hidden="" class="btn-clear"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-x-circle"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Supprimer le texte saisi</span></button></div><div data-test="listbox" class="_Content_1ssad_15 dropdown-menu _Root_1lysn_1" style="top: auto; bottom: 100%; max-height: calc(437.333px - 0.5rem);"></div><input type="hidden" value="" name="streetGeneric"><input type="hidden" value="" name="streetName"><input type="hidden" value="" name="noCity"><input type="hidden" value="" name="boroughNumber"><input type="hidden" value="" name="streetNameOfficial"></div> <div class="input-group-icon input-group-icon-left"><input data-test="input" required="" aria-busy="false" role="combobox" autocomplete="off" aria-autocomplete="list" aria-haspopup="true" aria-expanded="false" title="" id="radix-«rv»" class="form-control is-invalid" value="" name="streetNameCombobox" fdprocessedid="os361qh" data-gtm-form-interact-field-id="2" data-invalid="true"><span data-test="icon" aria-hidden="true" class="icon icon-color-neutral-stroke icon-search"></span><button type="button" data-test="clear" hidden="" class="btn-clear"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-x-circle"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Supprimer le texte saisi</span></button></div> <input data-test="input" required="" aria-busy="false" role="combobox" autocomplete="off" aria-autocomplete="list" aria-haspopup="true" aria-expanded="false" title="" id="radix-«rv»" class="form-control is-invalid" value="" name="streetNameCombobox" fdprocessedid="os361qh" data-gtm-form-interact-field-id="2" data-invalid="true">

cliquer sur bouton rechercher :

<button data-test="submit" form="«R6»" type="submit" class="btn-squared btn btn-primary" fdprocessedid="zlzwzw">Rechercher</button>

sélectionner une adresse : cliquer sur adresse

<dl class="dl-list separator"><dt>Adresse</dt><dd>1463 Rue Bishop (Montréal)</dd></dl> <ul data-test="list-group" class="_Root_piya8_1 list-group list-group-teaser list-group-complex"><li data-test="item" tabindex="0" class="focus:informative list-group-item list-group-item-action" role="listitem"><div class="row no-gutters"><div class="col"><div class="row no-gutters"><div class="col"><div data-test="title" class="list-group-item-title"><dl class="dl-list separator"><dt>Adresse</dt><dd>1463 Rue Bishop (Montréal)</dd></dl></div><div data-test="content" class="list-group-item-content empty-placeholder"><dl class="dl-list separator font:sm"><div><dt>Numéro de compte foncier</dt><dd>30 - F26131400</dd></div><div><dt>Numéro de matricule</dt><dd>9839-77-3228-4-000-0000</dd></div></dl></div></div></div></div><div class="col-auto ml-2"><div data-test="action-list" class="list-group-actions"><form method="post" action="/role-evaluation-fonciere/adresse/liste/resultat"><input type="hidden" value="1036820" name="evalUnitId"><button data-test="button" type="submit" class="btn-squared btn-icon btn btn-link"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-chevron-right"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Soumettre</span></button></form></div></div></div></li></ul> <li data-test="item" tabindex="0" class="focus:informative list-group-item list-group-item-action" role="listitem"><div class="row no-gutters"><div class="col"><div class="row no-gutters"><div class="col"><div data-test="title" class="list-group-item-title"><dl class="dl-list separator"><dt>Adresse</dt><dd>1463 Rue Bishop (Montréal)</dd></dl></div><div data-test="content" class="list-group-item-content empty-placeholder"><dl class="dl-list separator font:sm"><div><dt>Numéro de compte foncier</dt><dd>30 - F26131400</dd></div><div><dt>Numéro de matricule</dt><dd>9839-77-3228-4-000-0000</dd></div></dl></div></div></div></div><div class="col-auto ml-2"><div data-test="action-list" class="list-group-actions"><form method="post" action="/role-evaluation-fonciere/adresse/liste/resultat"><input type="hidden" value="1036820" name="evalUnitId"><button data-test="button" type="submit" class="btn-squared btn-icon btn btn-link"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-chevron-right"></span><span style="position: absolute; border: 0px; width: 1px; height: 1 px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Soumettre</span></button></form></div></div></div></li> <div class="row no-gutters"><div class="col"><div class="row no-gutters"><div class="col"><div data-test="title" class="list-group-item-title"><dl class="dl-list separator"><dt>Adresse</dt><dd>1463 Rue Bishop (Montréal)</dd></dl></div><div data-test="content" class="list-group-item-content empty-placeholder"><dl class="dl-list separator font:sm"><div><dt>Numéro de compte foncier</dt><dd>30 - F26131400</dd></div><div><dt>Numéro de matricule</dt><dd>9839-77-3228-4-000-0000</dd></div></dl></div></div></div></div><div class="col-auto ml-2"><div data-test="action-list" class="list-group-actions"><form method="post" action="/role-evaluation-fonciere/adresse/liste/resultat"><input type="hidden" value="1036820" name="evalUnitId"><button data-test="button" type="submit" class="btn-squared btn-icon btn btn-link"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-chevron-right"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Soumettre</span></button></form></div></div></div> <div class="col"><div class="row no-gutters"><div class="col"><div data-test="title" class="list-group-item-title"><dl class="dl-list separator"><dt>Adresse</dt><dd>1463 Rue Bishop (Montréal)</dd></dl></div><div data-test="content" class="list-group-item-content empty-placeholder"><dl class="dl-list separator font:sm"><div><dt>Numéro de compte foncier</dt><dd>30 - F26131400</dd></div><div><dt>Numéro de matricule</dt><dd>9839-77-3228-4-000-0000</dd></div></dl></div></div></div></div> <div class="col-auto ml-2"><div data-test="action-list" class="list-group-actions"><form method="post" action="/role-evaluation-fonciere/adresse/liste/resultat"><input type="hidden" value="1036820" name="evalUnitId"><button data-test="button" type="submit" class="btn-squared btn-icon btn btn-link"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-chevron-right"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Soumettre</span></button></form></div></div></div>

<button data-test="submit" form="«R6»" type="submit" class="btn-squared btn btn-primary" fdprocessedid="zlzwzw">Rechercher</button>

end page with relevant data (owner info, etc…)

{ … (keep the big JSON with sections/owners/caracteristiques/etc exactly as you shared) … }

To login into account :

where to click when entering montreal.ca

<button type="button" class="btn navbar-btn navbar-btn-icon btn-login btn-hide-label-md d-lg-inline-flex" id="shell-login-button" aria-label="Mon compte"><span class="icon icon-user-circle" aria-hidden="true"></span><span class="btn-label">Mon compte</span></button>

<span class="icon icon-user-circle" aria-hidden="true"></span>

<span class="btn-label">Mon compte</span>

where to enter email :

<input type="text" id="signInName" autofocus="" aria-describedby="signInName-error" fdprocessedid="xqic1a">

where to enter password :

<input type="password" id="password" autocomplete="current-password" aria-required="true" aria-describedby="password-error" fdprocessedid="3o0tfw">

where to click after putting login info to login :

<button id="next" type="submit" form="localAccountForm" fdprocessedid="pmstej">Me connecter</button>

Final note for Codex

Generate all files, wire the CLI, and make sure CSV overwrite + Sheets update in-row + snapshot export are working out of the box.

Add README.md explaining Google service account setup and Playwright install (playwright install).

Include unit tests for parsers.py (given the selectors) with sample HTML snippets.
logs/.gitkeep
New

No content

--------------------------------------------------------------------------------
FILE: README.md
SIZE: 26.3 KB | LINES: 431
--------------------------------------------------------------------------------
# SELENIUM-AUTOMATION-FOR-OWNER-NAME
# Montréal Role d'évaluation Scraper

This project automates the Montréal Rôle d’évaluation foncière workflow for CSV or Google Sheets inputs. It enriches rows with owner and assessment data while respecting ToS-friendly scraping practices (rate limiting, retries, and stealth browser behaviors).

## Features

- Playwright (Chromium) automation with basic stealth evasion.
- Supports CSV and Google Sheets sources via a unified CLI.
- Retries with exponential backoff and jittered delays between requests.
- SQLite cache prevents duplicate work on re-runs.
- Deterministic output schema appended to each data source.
- Atomic CSV overwrites, timestamped backups, and snapshot exports.
- Google Sheets batching with rollback-aware retry handling.
- Structured logging to console and `logs/run.log`.

## Requirements

- Python 3.11
- Playwright dependencies (Chromium browser binaries)

Install Python dependencies:

```bash
pip install -r requirements.txt
playwright install
```

## Environment Variables

Copy `.env.example` to `.env` and fill in the values:

| Variable | Description |
| --- | --- |
| `MONTREAL_EMAIL` | Optional: account email used when `--login` is supplied. |
| `MONTREAL_PASSWORD` | Optional: password for the Montréal account. |
| `GOOGLE_SERVICE_ACCOUNT_JSON` | Path to a Google service account JSON file or the JSON string itself. Required for Sheets mode. |
| `SHEET_NAME` / `SHEET_TAB` | Defaults for CLI flags. |
| `DELAY_MIN` / `DELAY_MAX` | Default jitter window (seconds). |
| `CACHE_PATH` | Path to the SQLite cache file. |
| `LOG_LEVEL` | Logging verbosity (e.g., `INFO`). |

## Google Sheets Setup

1. Create a Google Cloud project and enable the Sheets API.
2. Generate a service account with the "Editor" role.
3. Download the service account JSON and share your spreadsheet with the service account email.
4. Provide the JSON file path (or inline JSON string) via `GOOGLE_SERVICE_ACCOUNT_JSON`.

## CLI Usage

```bash
python main.py --csv ./input/mtl_targets.csv --max 250 --delay-min 1.5 --delay-max 3.0
python main.py --sheet "MTL Plex Leads" --tab "20-40" --from-row 2
python main.py --csv ./input/mtl_targets.csv --headful
python main.py --sheet "MTL Plex Leads" --tab "20-40" --login
```

## Configuring Git remotes for PR automation

This repository does not ship with a Git remote preconfigured. Tools that
attempt to open pull requests (including the provided `make_pr` helper)
require an upstream remote/branch to compare against. If you see errors such
as “no remote configured” or `fatal: No such remote: 'origin'`, add the
appropriate remote before re-running the tool:

```bash
git remote add origin https://github.com/MugiZer/SELENIUM-AUTOMATION-FOR-OWNER-NAME.git
git push -u origin work   # replace `work` with your current branch name
```

If you already have a different remote configured, you can update it instead:

```bash
git remote set-url origin https://github.com/MugiZer/SELENIUM-AUTOMATION-FOR-OWNER-NAME.git
```

After the first push, subsequent PR attempts will succeed because Git knows
which remote branch should receive updates.

### Manual pull request checklist

If you prefer creating the pull request through the GitHub UI (or need to
recover from a failed attempt), run the following commands locally. Replace
`<branch>` with the branch that contains your changes — you can always check it
with `git branch --show-current`.

```bash
# make sure all work is committed before switching
git status

# create or switch to the feature branch if necessary
git checkout -b <branch>        # or: git checkout <branch> if it already exists

# verify which branch you are on
git branch --show-current

# ensure the remote points to the public repository
git remote -v
git remote add origin https://github.com/MugiZer/SELENIUM-AUTOMATION-FOR-OWNER-NAME.git  # only if 'origin' is missing
git remote set-url origin https://github.com/MugiZer/SELENIUM-AUTOMATION-FOR-OWNER-NAME.git  # only if it points elsewhere

# publish the branch and establish the upstream tracking reference
git push -u origin <branch>
```

After the push completes, open the repository page in your browser and click
**Compare & pull request**. GitHub will pre-fill the base branch (`main`) and the
compare branch (`<branch>`). Review the diff, add a title/description, and submit
the PR. Future pushes to the same branch require only `git push` because the
upstream tracking relationship is already in place.

### Borough reference

The dataset must include a column containing the authoritative borough name for each address. The column name is `NO_ARROND_ILE_CUM` and each cell must match one of the following values exactly:

- Arrondissement de Villeray - Saint-Michel - Parc-Extension (Montréal)
- (Westmount)
- Arrondissement du Plateau-Mont-Royal (Montréal)
- Arrondissement du Sud-Ouest (Montréal)
- Arrondissement de Ville-Marie (Montréal)
- Arrondissement de Côte-des-Neiges - Notre-Dame-de-Grâce (Montréal)
- Saint Leonard
- Arrondissement de Lachine (Montréal)
- Arrondissement de Verdun (Montréal)
- Arrondissement de Rosemont - La Petite-Patrie
- Arrondissement de Pierrefonds - Roxboro (Montréal)
- Arrondissement d'Outremont (Montréal)
- Arrondissement de Saint-Laurent (Montréal)
- Arrondissement d'Ahuntsic-Cartierville
- Arrondissement de Mercier - Hochelaga-Maisonneuve (Montréal)

During scraping the list view may contain duplicate street names. The scraper uses the normalised value from `NO_ARROND_ILE_CUM` to pick the matching borough entry; when the column is missing or blank the workflow gracefully falls back to address-only matching and logs the loss of precision so operators can correct the dataset.

### Output Columns

Each processed row gains the following columns:

- `owner_names`
- `owner_type`
- `matricule`
- `tax_account_number`
- `municipality`
- `fiscal_years`
- `nb_logements`
- `assessed_terrain_current`
- `assessed_batiment_current`
- `assessed_total_current`
- `assessed_total_previous`
- `tax_distribution_json`
- `last_fetched_at`
- `source_url`
- `status`

## Logging

Logs are written to stdout and `logs/run.log` via a rotating handler. Adjust verbosity with the `LOG_LEVEL` environment variable.

## Testing

Unit tests cover the HTML parser logic:

```bash
pytest
```

## Troubleshooting

- **Playwright missing browsers**: run `playwright install`.
- **Authentication failures**: ensure `MONTREAL_EMAIL` and `MONTREAL_PASSWORD` are set and valid.
- **Sheets authentication**: confirm the spreadsheet is shared with the service account email and the JSON credentials are correct.
- **429 or 5xx responses**: the scraper retries automatically with exponential backoff while keeping rate limits.
- **Borough mismatches**: verify `NO_ARROND_ILE_CUM` values match the canonical list exactly; typos force the scraper to fall back to
  address-only matching and return a `multiple_matches` or `not_found` status.

## Appendix: DevTools Data (verbatim)

The following section is reproduced verbatim from the project brief to ensure selector fidelity.

✳️ DEVTOOLS DATA (append EXACTLY, do not modify)

https://montreal.ca/role-evaluation-fonciere/adresse

API NETWORK :

1)When we fill numéro d immeuble :

Request URL
https://www.google-analytics.com/g/collect?v=2&tid=G-X85NG0G8NT&gtm=45je5a11v9134341101z89134342162za200zb9134342162zd9134342162&_p=1759709177686&gcd=13l3l3l3l1l1&npa=0&dma=0&cid=1605043035.1759704688&ul=en-us&sr=1280x720&uaa=x86&uab=64&uafvl=Chromium%3B140.0.7339.185%7CNot%253DA%253FBrand%3B24.0.0.0%7CGoogle%2520Chrome%3B140.0.7339.185&uamb=0&uam=&uap=Windows&uapv=19.0.0&uaw=0&are=1&frm=0&pscdl=&_eu=AAAAAAQ&_s=1&tag_exp=101509157~103116026~103200004~103233427~104527907~104528500~104573694~104684208~104684211~104948813~115480710~115834636~115834638&sid=1759709127&sct=2&seg=1&dl=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse&dt=R%C3%B4le%20d%E2%80%99%C3%A9valuation%20fonci%C3%A8re&en=page_view&tfd=5478

Request Method
POST
Status Code
204 No Content
Remote Address
142.250.69.46:443
Referrer Policy
strict-origin-when-cross-origin
Request URL
https://www.google-analytics.com/g/collect?v=2&tid=G-X85NG0G8NT&gtm=45je5a11v9134341101za200zb9134342162zd9134342162&_p=1759709177686&gcd=13l3l3l3l1l1&npa=0&dma=0&cid=1605043035.1759704688&ul=en-us&sr=1280x720&uaa=x86&uab=64&uafvl=Chromium%3B140.0.7339.185%7CNot%253DA%253FBrand%3B24.0.0.0%7CGoogle%2520Chrome%3B140.0.7339.185&uamb=0&uam=&uap=Windows&uapv=19.0.0&uaw=0&are=1&frm=0&pscdl=&_eu=AEEAAAQ&_s=2&tag_exp=101509157~103116026~103200004~103233427~104527907~104528500~104573694~104684208~104684211~104948813~115480710~115834636~115834638&sid=1759709127&sct=2&seg=1&dl=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse&dt=R%C3%B4le%20d%E2%80%99%C3%A9valuation%20fonci%C3%A8re&en=form_start&ep.form_id=%C2%ABR6%C2%BB&ep.form_name=&ep.form_destination=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse%2Fliste&epn.form_length=13&ep.first_field_id=radix-%C2%ABr9%C2%BB&ep.first_field_name=civicNumber&ep.first_field_type=&epn.first_field_position=1&_et=4612&tfd=10492

2)when we fill Nom de la rue :
Request URL
https://montreal.ca/_next/data/info-recherche-2-3-13/fr-CA/role-evaluation-fonciere.json

Request Method
GET
Status Code
200 OK
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin
Request URL
https://montreal.ca/info-recherche/_next/static/css/406ef883613c4fbc.css

Request Method
GET
Status Code
200 OK (from disk cache)
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin
equest URL
https://montreal.ca/info-recherche/api/evaluation-fonciere/gem/streets?q=Bishop&page=1&size=10

Request Method
GET
Status Code
304 Not Modified
Remote Address
104.18.6.89:443
Referrer Policy
strict-origin-when-cross-origin
Request URL
https://www.google-analytics.com/g/collect?v=2&tid=G-X85NG0G8NT&gtm=45je5a11v9134341101z89134342162za200zb9134342162zd9134342162&_p=1759706936984&gcd=13l3l3l3l1l1&npa=0&dma=0&cid=1605043035.1759704688&ul=en-us&sr=1280x720&uaa=x86&uab=64&uafvl=Chromium%3B140.0.7339.185%7CNot%253DA%253FBrand%3B24.0.0.0%7CGoogle%2520Chrome%3B140.0.7339.185&uamb=0&uam=&uap=Windows&uapv=19.0.0&uaw=0&are=1&frm=0&pscdl=&_eu=AAAAAAQ&_s=1&tag_exp=101509157~103116026~103200004~103233427~104527906~104528500~104684208~104684211~104948813~115480710~115616986~115834636~115834638~115868795~115868797&sid=1759704706&sct=1&seg=1&dl=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse&dt=R%C3%B4le%20d%E2%80%99%C3%A9valuation%20fonci%C3%A8re&en=page_view&tfd=5989

Request URL
https://montreal.ca/info-recherche/api/evaluation-fonciere/gem/streets?q=Rue+Bishop%2C+Arrondissement+de+Ville-Marie+%28Montr%C3%A9al%29&page=1&size=10

Request Method
GET
Status Code
304 Not Modified
Remote Address
104.18.6.89:443
Referrer Policy
strict-origin-when-cross-origin
Request URL
https://www.google-analytics.com/g/collect?v=2&tid=G-X85NG0G8NT&gtm=45je5a11v9134341101za200zb9134342162zd9134342162&_p=1759706936984&gcd=13l3l3l3l1l1&npa=0&dma=0&cid=1605043035.1759704688&ul=en-us&sr=1280x720&uaa=x86&uab=64&uafvl=Chromium%3B140.0.7339.185%7CNot%253DA%253FBrand%3B24.0.0.0%7CGoogle%2520Chrome%3B140.0.7339.185&uamb=0&uam=&uap=Windows&uapv=19.0.0&uaw=0&are=1&frm=0&pscdl=&_eu=AEEAAAQ&_s=2&tag_exp=101509157~103116026~103200004~103233427~104527906~104528500~104684208~104684211~104948813~115480710~115616986~115834636~115834638~115868795~115868797&sid=1759704706&sct=1&seg=1&dl=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse&dt=R%C3%B4le%20d%E2%80%99%C3%A9valuation%20fonci%C3%A8re&en=form_start&ep.form_id=%C2%ABR6%C2%BB&ep.form_name=&ep.form_destination=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse%2Fliste&epn.form_length=13&ep.first_field_id=radix-%C2%ABrc%C2%BB&ep.first_field_name=streetNameCombobox&ep.first_field_type=&epn.first_field_position=2&_et=9062&tfd=15071

after you click search and new page loads

Request URL
https://api.montreal.ca/api/city-services/citizen/v2/organisations?limit=100

Request Method
GET
Status Code
304 Not Modified
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://montreal.ca/_next/data/info-recherche-2-3-13/fr-CA/role-evaluation-fonciere.json

Request Method
GET
Status Code
200 OK
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://montreal.ca/_next/data/info-recherche-2-3-13/fr-CA/role-evaluation-fonciere.json

Request Method
GET
Status Code
200 OK
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://montreal.ca/_next/data/info-recherche-2-3-13/fr-CA/role-evaluation-fonciere/adresse.json

Request Method
GET
Status Code
200 OK
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://montreal.ca/info-recherche/_next/static/css/406ef883613c4fbc.css

Request Method
GET
Status Code
200 OK (from disk cache)
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://montreal.ca/info-recherche/_next/static/css/b184c00d65df50f6.css

Request Method
GET
Status Code
200 OK (from disk cache)
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://www.google-analytics.com/g/collect?v=2&tid=G-X85NG0G8NT&gtm=45je5a11v9134341101z89134342162za200zb9134342162zd9134342162&_p=1759709531675&gcd=13l3l3l3l1l1&npa=0&dma=0&cid=1605043035.1759704688&ul=en-us&sr=1280x720&uaa=x86&uab=64&uafvl=Chromium%3B140.0.7339.185%7CNot%253DA%253FBrand%3B24.0.0.0%7CGoogle%2520Chrome%3B140.0.7339.185&uamb=0&uam=&uap=Windows&uapv=19.0.0&uaw=0&are=1&frm=0&pscdl=&_eu=AAAAAAQ&_s=1&tag_exp=101509157~103116026~103200004~103233427~104527906~104528500~104573694~104684208~104684211~104948813~115480710~115616985~115834636~115834638&sid=1759709127&sct=2&seg=1&dl=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse%2Fliste&dr=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse&dt=R%C3%B4le%20d%E2%80%99%C3%A9valuation%20fonci%C3%A8re&en=page_view&tfd=5994

when you click on confirmed address

Request URL
https://montreal.ca/_next/data/info-recherche-2-3-13/fr-CA/role-evaluation-fonciere/adresse/liste.json

Request Method
GET
Status Code
200 OK
Remote Address
104.18.6.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://montreal.ca/info-recherche/_next/static/css/17b088d930ab19b4.css

Request Method
GET
Status Code
200 OK (from disk cache)
Remote Address
104.18.7.89:443
Referrer Policy
strict-origin-when-cross-origin

Request URL
https://www.google-analytics.com/g/collect?v=2&tid=G-X85NG0G8NT&gtm=45je5a11v9134341101z89134342162za200zb9134342162zd9134342162&_p=1759709701553&gcd=13l3l3l3l1l1&npa=0&dma=0&cid=1605043035.1759704688&ul=en-us&sr=1280x720&uaa=x86&uab=64&uafvl=Chromium%3B140.0.7339.185%7CNot%253DA%253FBrand%3B24.0.0.0%7CGoogle%2520Chrome%3B140.0.7339.185&uamb=0&uam=&uap=Windows&uapv=19.0.0&uaw=0&are=1&frm=0&pscdl=&_eu=AAAAAAQ&_s=1&tag_exp=101509157~103116026~103200004~103233427~104527906~104528501~104573694~104684208~104684211~104948813~115480709~115834636~115834638&sid=1759709127&sct=2&seg=1&dl=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse%2Fliste%2Fresultat&dr=https%3A%2F%2Fmontreal.ca%2Frole-evaluation-fonciere%2Fadresse%2Fliste&dt=R%C3%B4le%20d%E2%80%99%C3%A9valuation%20fonci%C3%A8re&en=page_view&tfd=5789

FINAL URL WHERE THE ADRESSES AND DATA COMES FROM : Request URL
https://montreal.ca/_next/data/info-recherche-2-3-13/fr-CA/role-evaluation-fonciere/adresse/liste.json

Request Method
GET
Status Code
200 OK
Remote Address
104.18.6.89:443
Referrer Policy
strict-origin-when-cross-origin

—--------------------

ELEMENTS :

Numéro d immeuble :

<label data-test="label" id="«rt»" for="radix-«rs»" data-invalid="true">Numéro d'immeuble</label>

<div class="_TextInput-small_o1hr5_21 input-group-icon"><input data-test="input" required="" maxlength="6" pattern="^[0-9]{1,5}([a-zA-Z]{0,1})$" title="" id="radix-«rs»" class="form-control is-invalid" name="civicNumber" aria-describedby="radix-«ru» radix-«r15»" fdprocessedid="8nk3al" data-gtm-form-interact-field-id="1" data-invalid="true"><button type="button" data-test="clear" hidden="" class="btn-clear"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-x-circle"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Supprimer le texte saisi</span></button></div> <input data-test="input" required="" maxlength="6" pattern="^[0-9]{1,5}([a-zA-Z]{0,1})$" title="" id="radix-«rs»" class="form-control is-invalid" name="civicNumber" aria-describedby="radix-«ru» radix-«r15»" fdprocessedid="8nk3al" data-gtm-form-interact-field-id="1" data-invalid="true">

<span id="radix-«r15»" data-test="invalid" class="invalid-feedback is-invalid"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-xs icon-exclamation"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Erreur</span>Le numéro d'immeuble est requis.</span>

Nom de la rue :

<span id="radix-«r11»" data-test="help" class="form-text">Entrez le nom de la rue et faites une sélection.</span>

<div data-test="combobox" class="_Root_1ssad_1"><div class="input-group-icon input-group-icon-left"><input data-test="input" required="" aria-busy="false" role="combobox" autocomplete="off" aria-autocomplete="list" aria-haspopup="true" aria-expanded="false" title="" id="radix-«rv»" class="form-control is-invalid" value="" name="streetNameCombobox" fdprocessedid="os361qh" data-gtm-form-interact-field-id="2" data-invalid="true"><span data-test="icon" aria-hidden="true" class="icon icon-color-neutral-stroke icon-search"></span><button type="button" data-test="clear" hidden="" class="btn-clear"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-x-circle"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Supprimer le texte saisi</span></button></div><div data-test="listbox" class="_Content_1ssad_15 dropdown-menu _Root_1lysn_1" style="top: auto; bottom: 100%; max-height: calc(437.333px - 0.5rem);"></div><input type="hidden" value="" name="streetGeneric"><input type="hidden" value="" name="streetName"><input type="hidden" value="" name="noCity"><input type="hidden" value="" name="boroughNumber"><input type="hidden" value="" name="streetNameOfficial"></div> <div class="input-group-icon input-group-icon-left"><input data-test="input" required="" aria-busy="false" role="combobox" autocomplete="off" aria-autocomplete="list" aria-haspopup="true" aria-expanded="false" title="" id="radix-«rv»" class="form-control is-invalid" value="" name="streetNameCombobox" fdprocessedid="os361qh" data-gtm-form-interact-field-id="2" data-invalid="true"><span data-test="icon" aria-hidden="true" class="icon icon-color-neutral-stroke icon-search"></span><button type="button" data-test="clear" hidden="" class="btn-clear"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-x-circle"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Supprimer le texte saisi</span></button></div> <input data-test="input" required="" aria-busy="false" role="combobox" autocomplete="off" aria-autocomplete="list" aria-haspopup="true" aria-expanded="false" title="" id="radix-«rv»" class="form-control is-invalid" value="" name="streetNameCombobox" fdprocessedid="os361qh" data-gtm-form-interact-field-id="2" data-invalid="true">

cliquer sur bouton rechercher :

<button data-test="submit" form="«R6»" type="submit" class="btn-squared btn btn-primary" fdprocessedid="zlzwzw">Rechercher</button>

sélectionner une adresse : cliquer sur adresse

<dl class="dl-list separator"><dt>Adresse</dt><dd>1463 Rue Bishop (Montréal)</dd></dl> <ul data-test="list-group" class="_Root_piya8_1 list-group list-group-teaser list-group-complex"><li data-test="item" tabindex="0" class="focus:informative list-group-item list-group-item-action" role="listitem"><div class="row no-gutters"><div class="col"><div class="row no-gutters"><div class="col"><div data-test="title" class="list-group-item-title"><dl class="dl-list separator"><dt>Adresse</dt><dd>1463 Rue Bishop (Montréal)</dd></dl></div><div data-test="content" class="list-group-item-content empty-placeholder"><dl class="dl-list separator font:sm"><div><dt>Numéro de compte foncier</dt><dd>30 - F26131400</dd></div><div><dt>Numéro de matricule</dt><dd>9839-77-3228-4-000-0000</dd></div></dl></div></div></div></div><div class="col-auto ml-2"><div data-test="action-list" class="list-group-actions"><form method="post" action="/role-evaluation-fonciere/adresse/liste/resultat"><input type="hidden" value="1036820" name="evalUnitId"><button data-test="button" type="submit" class="btn-squared btn-icon btn btn-link"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-chevron-right"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Soumettre</span></button></form></div></div></div></li></ul> <li data-test="item" tabindex="0" class="focus:informative list-group-item list-group-item-action" role="listitem"><div class="row no-gutters"><div class="col"><div class="row no-gutters"><div class="col"><div data-test="title" class="list-group-item-title"><dl class="dl-list separator"><dt>Adresse</dt><dd>1463 Rue Bishop (Montréal)</dd></dl></div><div data-test="content" class="list-group-item-content empty-placeholder"><dl class="dl-list separator font:sm"><div><dt>Numéro de compte foncier</dt><dd>30 - F26131400</dd></div><div><dt>Numéro de matricule</dt><dd>9839-77-3228-4-000-0000</dd></div></dl></div></div></div></div><div class="col-auto ml-2"><div data-test="action-list" class="list-group-actions"><form method="post" action="/role-evaluation-fonciere/adresse/liste/resultat"><input type="hidden" value="1036820" name="evalUnitId"><button data-test="button" type="submit" class="btn-squared btn-icon btn btn-link"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-chevron-right"></span><span style="position: absolute; border: 0px; width: 1px; height: 1 px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Soumettre</span></button></form></div></div></div></li> <div class="row no-gutters"><div class="col"><div class="row no-gutters"><div class="col"><div data-test="title" class="list-group-item-title"><dl class="dl-list separator"><dt>Adresse</dt><dd>1463 Rue Bishop (Montréal)</dd></dl></div><div data-test="content" class="list-group-item-content empty-placeholder"><dl class="dl-list separator font:sm"><div><dt>Numéro de compte foncier</dt><dd>30 - F26131400</dd></div><div><dt>Numéro de matricule</dt><dd>9839-77-3228-4-000-0000</dd></div></dl></div></div></div></div><div class="col-auto ml-2"><div data-test="action-list" class="list-group-actions"><form method="post" action="/role-evaluation-fonciere/adresse/liste/resultat"><input type="hidden" value="1036820" name="evalUnitId"><button data-test="button" type="submit" class="btn-squared btn-icon btn btn-link"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-chevron-right"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Soumettre</span></button></form></div></div></div> <div class="col"><div class="row no-gutters"><div class="col"><div data-test="title" class="list-group-item-title"><dl class="dl-list separator"><dt>Adresse</dt><dd>1463 Rue Bishop (Montréal)</dd></dl></div><div data-test="content" class="list-group-item-content empty-placeholder"><dl class="dl-list separator font:sm"><div><dt>Numéro de compte foncier</dt><dd>30 - F26131400</dd></div><div><dt>Numéro de matricule</dt><dd>9839-77-3228-4-000-0000</dd></div></dl></div></div></div></div> <div class="col-auto ml-2"><div data-test="action-list" class="list-group-actions"><form method="post" action="/role-evaluation-fonciere/adresse/liste/resultat"><input type="hidden" value="1036820" name="evalUnitId"><button data-test="button" type="submit" class="btn-squared btn-icon btn btn-link"><span data-test="icon" aria-hidden="true" focusable="false" class="icon icon-md icon-chevron-right"></span><span style="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;">Soumettre</span></button></form></div></div></div>

<button data-test="submit" form="«R6»" type="submit" class="btn-squared btn btn-primary" fdprocessedid="zlzwzw">Rechercher</button>

end page with relevant data (owner info, etc…)

{ … (keep the big JSON with sections/owners/caracteristiques/etc exactly as you shared) … }

To login into account :

where to click when entering montreal.ca

<button type="button" class="btn navbar-btn navbar-btn-icon btn-login btn-hide-label-md d-lg-inline-flex" id="shell-login-button" aria-label="Mon compte"><span class="icon icon-user-circle" aria-hidden="true"></span><span class="btn-label">Mon compte</span></button>

<span class="icon icon-user-circle" aria-hidden="true"></span>

<span class="btn-label">Mon compte</span>

where to enter email :

<input type="text" id="signInName" autofocus="" aria-describedby="signInName-error" fdprocessedid="xqic1a">

where to enter password :

<input type="password" id="password" autocomplete="current-password" aria-required="true" aria-describedby="password-error" fdprocessedid="3o0tfw">

where to click after putting login info to login :

<button id="next" type="submit" form="localAccountForm" fdprocessedid="pmstej">Me connecter</button>

Final note for Codex

Generate all files, wire the CLI, and make sure CSV overwrite + Sheets update in-row + snapshot export are working out of the box.

Add README.md explaining Google service account setup and Playwright install (playwright install).

Include unit tests for parsers.py (given the selectors) with sample HTML snippets.


================================================================================
FOLDER: scraper
================================================================================

--------------------------------------------------------------------------------
FILE: scraper/browser.py
STATUS: New
SIZE: 1.67 KB | LINES: 48
--------------------------------------------------------------------------------
import asyncio
import contextlib
import json
import random
from pathlib import Path
from typing import Iterator, Optional

from playwright.sync_api import Browser, BrowserContext, Page, Playwright, sync_playwright


USER_AGENTS = [
    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
    "Mozilla/5.0 (Macintosh; Intel Mac OS X 13_4) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Safari/605.1.15",
    "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118.0.0.0 Safari/537.36",
]


@contextlib.contextmanager
def launch_browser(headless: bool = True) -> Iterator[tuple[Playwright, Browser, BrowserContext]]:
    playwright = sync_playwright().start()
    browser = playwright.chromium.launch(headless=headless)
    user_agent = random.choice(USER_AGENTS)
    context = browser.new_context(user_agent=user_agent, viewport={"width": 1280, "height": 720})
    add_stealth(context)
    try:
        yield playwright, browser, context
    finally:
        context.close()
        browser.close()
        playwright.stop()


def add_stealth(context: BrowserContext) -> None:
    """Apply basic stealth scripts to the context."""
    context.add_init_script(
        """
        Object.defineProperty(navigator, 'webdriver', {get: () => undefined});
        window.chrome = { runtime: {} };
        Object.defineProperty(navigator, 'languages', {get: () => ['en-US', 'en']});
        Object.defineProperty(navigator, 'plugins', {get: () => [1, 2, 3, 4, 5]});
        """
    )


def new_page(context: BrowserContext) -> Page:
    page = context.new_page()
    page.set_default_timeout(10_000)
    return page

--------------------------------------------------------------------------------
FILE: scraper/cache.py
STATUS: New
SIZE: 1.46 KB | LINES: 51
--------------------------------------------------------------------------------
import json
import sqlite3
from pathlib import Path
from typing import Any, Dict, Optional


class Cache:
    """SQLite-backed cache for previously scraped payloads."""

    def __init__(self, path: Path) -> None:
        self.path = path
        self.path.parent.mkdir(parents=True, exist_ok=True)
        self._conn = sqlite3.connect(self.path)
        self._conn.execute(
            """
            CREATE TABLE IF NOT EXISTS cache (
                key TEXT PRIMARY KEY,
                data TEXT NOT NULL,
                updated_at TEXT NOT NULL
            )
            """
        )
        self._conn.commit()

    def __enter__(self) -> "Cache":
        return self

    def __exit__(self, exc_type, exc, tb) -> None:  # type: ignore[override]
        self.close()

    def get(self, key: str) -> Optional[Dict[str, Any]]:
        cur = self._conn.execute("SELECT data FROM cache WHERE key = ?", (key,))
        row = cur.fetchone()
        if not row:
            return None
        return json.loads(row[0])

    def set(self, key: str, data: Dict[str, Any], timestamp: str) -> None:
        payload = json.dumps(data, ensure_ascii=False)
        self._conn.execute(
            "REPLACE INTO cache (key, data, updated_at) VALUES (?, ?, ?)",
            (key, payload, timestamp),
        )
        self._conn.commit()

    def close(self) -> None:
        self._conn.close()


def normalize_key(*parts: str) -> str:
    return "|".join(part.strip().lower() for part in parts if part)

--------------------------------------------------------------------------------
FILE: scraper/csvio.py
STATUS: New
SIZE: 1.23 KB | LINES: 43
--------------------------------------------------------------------------------
import datetime as dt
from pathlib import Path
from typing import Dict

import pandas as pd

from .schema import OUTPUT_COLUMNS, attach_normalized_borough


def read_csv(path: Path) -> pd.DataFrame:
    df = pd.read_csv(path)
    for col in OUTPUT_COLUMNS:
        if col not in df.columns:
            df[col] = ""
    return df


def write_csv(path: Path, df: pd.DataFrame) -> Path:
    tmp_path = path.with_suffix(path.suffix + ".tmp")
    df.to_csv(tmp_path, index=False)
    tmp_path.replace(path)
    return path


def export_snapshot(df: pd.DataFrame, exports_dir: Path) -> Path:
    exports_dir.mkdir(parents=True, exist_ok=True)
    timestamp = dt.datetime.utcnow().strftime("%Y%m%d_%H%M")
    snapshot_path = exports_dir / f"enriched_{timestamp}.csv"
    df.to_csv(snapshot_path, index=False)
    return snapshot_path


def backup_original(path: Path, df: pd.DataFrame) -> Path:
    timestamp = dt.datetime.utcnow().strftime("%Y%m%d_%H%M")
    backup_path = path.with_name(f"{path.stem}_{timestamp}{path.suffix}")
    df.to_csv(backup_path, index=False)
    return backup_path


def ensure_output_columns(row: Dict[str, str]) -> Dict[str, str]:
    for col in OUTPUT_COLUMNS:
        row.setdefault(col, "")
    return attach_normalized_borough(row)

--------------------------------------------------------------------------------
FILE: scraper/log.py
STATUS: New
SIZE: 1.56 KB | LINES: 50
--------------------------------------------------------------------------------
import logging
from logging.handlers import RotatingFileHandler
from pathlib import Path
from typing import Optional, Union

from rich.console import Console
from rich.logging import RichHandler


LOG_PATH = Path("logs/run.log")
LevelArg = Union[int, str]


def _resolve_level(level: LevelArg) -> int:
    """Return a numeric logging level from either an int or string value."""
    if isinstance(level, int):
        return level
    if isinstance(level, str):
        value = getattr(logging, level.upper(), None)
        if isinstance(value, int):
            return value
        raise ValueError(f"Unknown logging level: {level}")
    raise TypeError("level must be an int or a str")


def configure_logging(level: LevelArg = "INFO", log_path: Optional[Path] = None) -> None:
    """Configure root logging with rich console and rotating file."""
    log_path = log_path or LOG_PATH
    log_path.parent.mkdir(parents=True, exist_ok=True)

    root = logging.getLogger()
    if root.handlers:
        # Already configured
        return

    numeric_level = _resolve_level(level)

    console_handler = RichHandler(console=Console(), markup=True, rich_tracebacks=True)
    console_handler.setLevel(numeric_level)

    file_handler = RotatingFileHandler(log_path, maxBytes=1_000_000, backupCount=5)
    file_handler.setLevel(numeric_level)
    file_formatter = logging.Formatter(
        "%(asctime)s | %(levelname)s | %(name)s | %(message)s"
    )
    file_handler.setFormatter(file_formatter)

    root.setLevel(numeric_level)
    root.addHandler(console_handler)
    root.addHandler(file_handler)

--------------------------------------------------------------------------------
FILE: scraper/montreal_role.py
STATUS: New
SIZE: 18.08 KB | LINES: 478
--------------------------------------------------------------------------------
import datetime as dt
import json
import logging
import re
import urllib.error
import urllib.parse
import urllib.request
from dataclasses import dataclass
from typing import Any, Dict, List, Optional

from playwright.sync_api import Page, TimeoutError

from .cache import Cache, normalize_key
from .parsers import parse_result_json, parse_result_page
from .rate import RateLimiter, retryable
from .schema import (
    CANONICAL_BOROUGH_NAMES,
    BOROUGH_COLUMN,
    NORMALIZED_BOROUGH_FIELD,
    normalize_borough,
)

logger = logging.getLogger(__name__)

BASE_URL = "https://montreal.ca/role-evaluation-fonciere/adresse"
STREET_API = "https://montreal.ca/info-recherche/api/evaluation-fonciere/gem/streets"


@dataclass
class AddressQuery:
    civic_number: str
    street_name: str
    raw_address: str
    borough: str = ""

    @property
    def cache_key(self) -> str:
        return normalize_key(self.civic_number, self.street_name or self.raw_address)


class MontrealRoleScraper:
    def __init__(
        self,
        page: Page,
        cache: Cache,
        rate_limiter: RateLimiter,
        delay_after_actions: bool = True,
        login_email: Optional[str] = None,
        login_password: Optional[str] = None,
    ) -> None:
        self.page = page
        self.cache = cache
        self.rate = rate_limiter
        self.delay_after_actions = delay_after_actions
        self.login_email = login_email
        self.login_password = login_password
        self._auto_login_attempted = False

    def sleep(self):
        if self.delay_after_actions:
            self.rate.sleep()

    def fetch(self, query: AddressQuery) -> Dict[str, str]:
        cached = self.cache.get(query.cache_key)
        if cached:
            logger.info("Cache hit for %s", query.raw_address)
            return cached
        logger.info("Processing %s", query.raw_address)
        status, payload = self._perform_search(query)
        if status == "ok":
            payload["status"] = "ok"
            payload["last_fetched_at"] = dt.datetime.utcnow().isoformat()
            payload["source_url"] = self.page.url
            self.cache.set(query.cache_key, payload, payload["last_fetched_at"])
            return payload
        payload.setdefault("status", status)
        return payload

    @retryable(attempts=3)
    def _perform_search(self, query: AddressQuery):
        attempted_login = False
        while True:
            try:
                self.page.goto(BASE_URL, wait_until="load")
            except TimeoutError:
                self.page.reload()
            if self._on_login_page():
                logger.info("Authentication wall detected during navigation; attempting login")
                if attempted_login or not self._ensure_authenticated():
                    return "error:auth_required", {}
                attempted_login = True
                continue
            self.sleep()
            self._fill_form(query)
            self.sleep()
            status, result = self._select_address(query)
            if status == "auth_required":
                logger.info("Authentication wall detected after address submission; attempting login")
                if attempted_login or not self._ensure_authenticated():
                    return "error:auth_required", {}
                attempted_login = True
                continue
            if status != "ok":
                return status, result
            self.sleep()
            final_data = self._parse_final_page()
            return "ok", final_data

    def login(self, email: str, password: str) -> None:
        logger.info("Attempting login")
        self.page.goto("https://montreal.ca/", wait_until="load")
        self.page.click("button#shell-login-button")
        self.page.fill("input#signInName", email)
        self.page.fill("input#password", password)
        self.page.click("button#next")
        self.page.wait_for_load_state("networkidle")
        logger.info("Login flow completed")

    def _fill_form(self, query: AddressQuery) -> None:
        # Selectors sourced from the provided DevTools snapshot for reliability.
        civic_locator = self.page.locator("input[data-test='input'][name='civicNumber']")
        civic_locator.wait_for(state="visible")
        civic_locator.fill(query.civic_number)
        try:
            self.sleep()
            suggestion = self._best_street_suggestion(query)
        except Exception:
            suggestion = {}
        finally:
            self.sleep()
        street_value = suggestion.get("displayName") or suggestion.get("fullStreetName")
        if street_value:
            street_locator = self.page.locator(
                "div[data-test='combobox'] input[data-test='input'][name='streetNameCombobox']"
            )
            street_locator.wait_for(state="visible")
            street_locator.fill(street_value)
            self.page.evaluate(
                "(suggestion) => {"
                "document.querySelector(\"input[name='streetGeneric']\").value = suggestion.streetGeneric || '';"
                "document.querySelector(\"input[name='streetName']\").value = suggestion.streetName || '';"
                "document.querySelector(\"input[name='noCity']\").value = suggestion.noCity || '';"
                "document.querySelector(\"input[name='boroughNumber']\").value = suggestion.boroughNumber || '';"
                "document.querySelector(\"input[name='streetNameOfficial']\").value = suggestion.streetNameOfficial || '';"
                "}",
                suggestion,
            )
        else:
            street_locator = self.page.locator(
                "div[data-test='combobox'] input[data-test='input'][name='streetNameCombobox']"
            )
            street_locator.wait_for(state="visible")
            street_locator.fill(query.street_name)
        submit_locator = self.page.locator("button[data-test='submit'][form]")
        submit_locator.wait_for(state="attached")
        submit_locator.click()
        self.page.wait_for_load_state("networkidle")

    def _select_address(self, query: AddressQuery):
        if self._on_login_page():
            return "auth_required", {}
        try:
            self.page.wait_for_url(re.compile(r"/role-evaluation-fonciere/adresse/liste"), timeout=10_000)
        except TimeoutError:
            return "not_found", {}
        items = self.page.locator("ul[data-test='list-group'] li[data-test='item']")
        count = items.count()
        if count == 0:
            return "not_found", {}
        normalized_target = _normalize_address(query)
        target_borough = normalize_borough(query.borough)
        if query.borough and target_borough and target_borough not in CANONICAL_BOROUGH_NAMES:
            logger.debug(
                "Unrecognised borough '%s' normalised to '%s' for address matching",
                query.borough,
                target_borough,
            )
        candidates = _gather_candidates(items)
        status, matched_index = _choose_candidate(
            candidates, normalized_target, target_borough
        )
        if status != "ok" or matched_index is None:
            if status == "multiple_matches":
                logger.warning(
                    "Multiple matches for %s; borough '%s' could not be resolved",
                    query.raw_address,
                    query.borough or "",
                )
            elif status == "not_found":
                if target_borough:
                    logger.warning(
                        "No address matched borough '%s' for %s",
                        query.borough or "",
                        query.raw_address,
                    )
                else:
                    logger.warning(
                        "No address candidates found for %s", query.raw_address
                    )
            return status, {}
        matched_candidate = next(
            (candidate for candidate in candidates if candidate["index"] == matched_index),
            None,
        )
        if target_borough and matched_candidate and not normalize_borough(
            matched_candidate["borough"]
        ):
            logger.debug(
                "No borough text detected for candidate index %s when matching %s",
                matched_index,
                query.raw_address,
            )
        items.nth(matched_index).locator("form button[data-test='button']").click()
        try:
            self.page.wait_for_url(re.compile(r"/role-evaluation-fonciere/adresse/liste/resultat"), timeout=10_000)
        except TimeoutError:
            return "error:timeout", {}
        if self._on_login_page():
            return "auth_required", {}
        self.page.wait_for_load_state("networkidle")
        return "ok", {}

    def _parse_final_page(self) -> Dict[str, str]:
        next_data = None
        try:
            next_data = self.page.evaluate("() => window.__NEXT_DATA__ || null")
        except Exception as exc:
            logger.debug("Unable to evaluate __NEXT_DATA__: %s", exc)
        if isinstance(next_data, dict):
            for url in _candidate_next_data_urls(next_data):
                if not url:
                    continue
                try:
                    self.sleep()
                    response = self.page.context.request.get(url)
                except Exception as exc:
                    logger.debug("Error fetching %s: %s", url, exc)
                    continue
                if not getattr(response, "ok", False):
                    logger.debug("_next data request failed for %s with status %s", url, response.status)
                    continue
                try:
                    payload = response.json()
                except Exception as exc:
                    logger.debug("Unable to decode JSON from %s: %s", url, exc)
                    continue
                try:
                    result = parse_result_json(payload)
                except ValueError:
                    logger.debug("JSON payload from %s did not contain parsable HTML", url)
                    continue
                except Exception as exc:
                    logger.debug("Failed to parse JSON payload from %s: %s", url, exc)
                    continue
                logger.info("Parsed result page via _next JSON payload: %s", url)
                return result
        html = self.page.content()
        data = parse_result_page(html)
        return data

    @retryable(attempts=3)
    def _best_street_suggestion(self, query: AddressQuery) -> Dict[str, str]:
        self.sleep()
        params = urllib.parse.urlencode({"q": query.street_name, "page": 1, "size": 10})
        url = f"{STREET_API}?{params}"
        request = urllib.request.Request(url, headers={"Accept": "application/json"})
        try:
            with urllib.request.urlopen(request) as response:
                payload = json.loads(response.read().decode("utf-8"))
                status = getattr(response, "status", 200)
                if status >= 500:
                    raise urllib.error.HTTPError(url, status, "Server error", hdrs=None, fp=None)
        except urllib.error.HTTPError as exc:
            if exc.code == 429 or exc.code >= 500:
                logger.warning("Street suggestion API throttled (%s), retrying", exc.code)
                raise
            logger.debug("Street suggestion HTTP error %s", exc.code)
            return {}
        finally:
            self.sleep()
        suggestions = payload.get("data") or payload
        if not suggestions:
            return {}
        normalized_target = _normalize(query.street_name)
        for suggestion in suggestions:
            display = suggestion.get("displayName") or suggestion.get("fullStreetName") or ""
            if _normalize(display) == normalized_target:
                return suggestion
        return suggestions[0]

    def _on_login_page(self) -> bool:
        try:
            current_url = self.page.url
        except Exception:
            current_url = ""
        if current_url and ("login" in current_url or "compte" in current_url):
            return True
        try:
            locator = self.page.locator("input#signInName")
            return locator.count() > 0
        except Exception:
            return False

    def _ensure_authenticated(self) -> bool:
        if self._auto_login_attempted:
            logger.error("Authentication wall encountered after previous login attempt")
            return False
        if not self.login_email or not self.login_password:
            logger.error("Authentication required but credentials are unavailable")
            return False
        self._auto_login_attempted = True
        logger.info("Automatically signing in with configured credentials")
        self.login(self.login_email, self.login_password)
        try:
            self.page.wait_for_load_state("networkidle")
        except TimeoutError:
            pass
        self.page.goto(BASE_URL, wait_until="load")
        return not self._on_login_page()


def _normalize_address(query: AddressQuery) -> str:
    if query.civic_number and query.street_name:
        return _normalize(f"{query.civic_number} {query.street_name}")
    return _normalize(query.raw_address)


def _normalize(value: str) -> str:
    value = value or ""
    value = value.lower()
    value = re.sub(r"[^a-z0-9]", "", value)
    return value


def _extract_borough_from_item(item) -> str:
    try:
        return item.evaluate(
            """
            (element) => {
                const normalise = (text) =>
                    text ? text.replace(/\s+/g, " ").trim() : "";
                const labels = element.querySelectorAll("dt");
                for (const label of labels) {
                    const labelText = normalise(label.textContent || "").toLowerCase();
                    if (!labelText) {
                        continue;
                    }
                    if (labelText.includes("arrondissement") || labelText.includes("borough")) {
                        let sibling = label.nextElementSibling;
                        while (sibling && sibling.tagName !== "DD") {
                            sibling = sibling.nextElementSibling;
                        }
                        if (sibling) {
                            return normalise(sibling.textContent || "");
                        }
                    }
                }
                const dataAttr = element.querySelector('[data-test="borough"]');
                if (dataAttr) {
                    return normalise(dataAttr.textContent || "");
                }
                return "";
            }
            """
        )
    except Exception:
        return ""


def _gather_candidates(items) -> List[Dict[str, str]]:
    candidates: List[Dict[str, str]] = []
    count = items.count()
    for idx in range(count):
        dd_locator = items.nth(idx).locator("dl dd").first
        try:
            address_text = dd_locator.inner_text(timeout=5_000)
        except Exception:
            continue
        normalized_address = _normalize(address_text)
        borough_text = _extract_borough_from_item(items.nth(idx))
        candidates.append(
            {
                "index": idx,
                "address": address_text,
                "normalized_address": normalized_address,
                "borough": borough_text,
                "normalized_borough": normalize_borough(borough_text),
            }
        )
    return candidates


def _choose_candidate(
    candidates: List[Dict[str, str]],
    normalized_target: str,
    target_borough: str,
):
    if not candidates:
        return "not_found", None

    matching_address = [
        candidate
        for candidate in candidates
        if candidate["normalized_address"] == normalized_target
    ]

    if target_borough:
        borough_matches = [
            candidate
            for candidate in matching_address
            if candidate["normalized_borough"] == target_borough
        ]
        if borough_matches:
            return "ok", borough_matches[0]["index"]
        if matching_address:
            if len(matching_address) == 1 and not matching_address[0]["normalized_borough"]:
                return "ok", matching_address[0]["index"]
            return "multiple_matches", None
        # No exact address match but borough provided; treat as unresolved.
        return "not_found", None

    if matching_address:
        return "ok", matching_address[0]["index"]

    if len(candidates) == 1:
        return "ok", candidates[0]["index"]

    return "multiple_matches", None


def _candidate_next_data_urls(next_data: Dict[str, Any]) -> List[str]:
    build_id = next_data.get("buildId")
    if not build_id:
        return []
    locale = next_data.get("locale") or next_data.get("defaultLocale") or "fr-CA"
    path = "/role-evaluation-fonciere/adresse/liste"
    urls: List[str] = []
    base = "https://montreal.ca"
    urls.append(f"{base}/_next/data/{build_id}/{locale}{path}.json")
    asset_prefix = next_data.get("assetPrefix") or ""
    asset_prefix = asset_prefix.rstrip("/")
    if asset_prefix and asset_prefix != "/":
        prefixed = f"{base}{asset_prefix}/_next/data/{build_id}/{locale}{path}.json"
        if prefixed not in urls:
            urls.append(prefixed)
    return urls


def parse_input_row(row: Dict[str, str]) -> Optional[AddressQuery]:
    civic_number = clean_number(row.get("civicNumber") or row.get("civic_number"))
    street_name = (row.get("streetName") or row.get("street_name") or "").strip()
    raw_address = row.get("address") or row.get("Adresse") or ""
    borough = (
        row.get(NORMALIZED_BOROUGH_FIELD)
        or row.get(BOROUGH_COLUMN)
        or row.get("borough")
        or ""
    )
    if not civic_number and raw_address:
        match = re.match(r"(\d+[a-zA-Z]?)\s+(.*)", raw_address)
        if match:
            civic_number = match.group(1)
            street_name = street_name or match.group(2)
    street_name = street_name.strip()
    if not civic_number or not street_name:
        return None
    return AddressQuery(
        civic_number=civic_number,
        street_name=street_name,
        raw_address=raw_address or f"{civic_number} {street_name}",
        borough=borough,
    )


def clean_number(value: Optional[str]) -> str:
    if not value:
        return ""
    return re.sub(r"[^0-9a-zA-Z]", "", value)

--------------------------------------------------------------------------------
FILE: scraper/parsers.py
STATUS: New
SIZE: 4.28 KB | LINES: 121
--------------------------------------------------------------------------------
import json
import re
from typing import Any, Dict, Iterable, List, Optional, Sequence, Set

from selectolax.parser import HTMLParser

from .schema import OUTPUT_COLUMNS


OWNER_CORP_KEYWORDS = ["inc", "ltée", "québec inc", "corp", "corporation"]


def clean_text(value: Optional[str]) -> str:
    if not value:
        return ""
    return re.sub(r"\s+", " ", value).strip()


def parse_money(value: str) -> str:
    value = value.replace("\xa0", " ")
    digits = re.sub(r"[^0-9.-]", "", value)
    return digits


def parse_percentage(value: str) -> str:
    return re.sub(r"[^0-9.,]", "", value).replace(",", ".")


def parse_result_page(html: str) -> Dict[str, str]:
    tree = HTMLParser(html)
    data: Dict[str, str] = {col: "" for col in OUTPUT_COLUMNS}

    municipality_node = tree.css_first(
        "header.page-header .content-header-extras .list-inline-item div div:nth-child(1)"
    )
    if municipality_node:
        data["municipality"] = clean_text(municipality_node.text())

    fiscal_node = tree.css_first(
        "header.page-header .content-header-extras .list-inline-item div div:nth-child(2)"
    )
    if fiscal_node:
        data["fiscal_years"] = clean_text(fiscal_node.text())

    owners_section = _section_by_heading(tree, "proprietaires")
    owner_names: List[str] = []
    if owners_section:
        for item in owners_section.css("ul.list > li.list-item"):
            value_node = item.css_first(".list-item-content")
            value_text = clean_text(value_node.text() if value_node else "")
            if value_text:
                owner_names.append(value_text)
        if owner_names:
            data["owner_names"] = "; ".join(owner_names)
            owner_type = "person"
            lowered = data["owner_names"].lower()
            if any(keyword in lowered for keyword in OWNER_CORP_KEYWORDS):
                owner_type = "corporation"
            data["owner_type"] = owner_type
        else:
            data["owner_type"] = "unknown"
    else:
        data["owner_type"] = "unknown"

    identification_section = _section_by_heading(tree, "identification")
    if identification_section:
        mapping = _parse_dl_list(identification_section)
        if "Numéro de matricule" in mapping:
            data["matricule"] = mapping["Numéro de matricule"]
        if "Numéro de compte foncier" in mapping:
            data["tax_account_number"] = mapping["Numéro de compte foncier"]

    building_section = _section_by_heading(tree, "caracteristiques")
    if building_section:
        for heading in building_section.css("h3.h4"):
            if "Caractéristiques du bâtiment principal" in heading.text():
                list_mapping = _parse_dl_list(building_section)
                if "Nombre de logements" in list_mapping:
                    data["nb_logements"] = list_mapping["Nombre de logements"]

    value_section = _section_by_heading(tree, "valeur")
    if value_section:
        data.update(_parse_values(value_section))

    distribution_section = _find_section_with_table(value_section)
    if distribution_section:
        distribution = []
        table = distribution_section.css_first("table")
        if table:
            for row in table.css("tr"):
                cells = [clean_text(td.text()) for td in row.css("th, td")]
                if len(cells) >= 2 and cells[0].lower() != "sous-catégorie":
                    distribution.append(
                        {
                            "subcategory": cells[0],
                            "percentage": parse_percentage(cells[1]) if len(cells) > 1 else "",
                        }
                    )
        if distribution:
            data["tax_distribution_json"] = json.dumps(distribution, ensure_ascii=False)

    return data


def parse_result_json(payload: Dict[str, Any]) -> Dict[str, str]:
    normalized = _normalize_json_payload(payload)
    if _has_meaningful_data(normalized):
        return normalized

    html_candidates = list(_extract_html_candidates(payload))
    if not html_candidates:
        raise ValueError("No usable content found in JSON payload")
    for candidate in html_candidates:
        if not candidate:
            continue
        try:
            result = parse_result_page(candidate)
        except Exception:
            continue
        if _has_meaningful_data(result):
            return

